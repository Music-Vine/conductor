---
phase: 01-foundation-and-infrastructure
plan: 04
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/atoms/platformAtom.ts
  - src/atoms/index.ts
  - src/providers/JotaiProvider.tsx
  - src/providers/ThemeProvider.tsx
  - src/providers/index.ts
  - src/components/PlatformToggle.tsx
  - src/app/globals.css
autonomous: true

must_haves:
  truths:
    - "Platform context (music-vine or uppbeat) is available via Jotai atom"
    - "Platform choice persists across browser sessions via localStorage"
    - "Switching platforms changes the color theme immediately"
    - "Platform toggle shows iOS-style segmented control"
  artifacts:
    - path: "src/atoms/platformAtom.ts"
      provides: "Platform state atom"
      exports: ["platformAtom", "platformThemeAtom"]
    - path: "src/providers/JotaiProvider.tsx"
      provides: "Jotai provider with hydration"
      exports: ["JotaiProvider"]
    - path: "src/components/PlatformToggle.tsx"
      provides: "Platform toggle UI component"
      exports: ["PlatformToggle"]
  key_links:
    - from: "src/providers/ThemeProvider.tsx"
      to: "src/atoms/platformAtom.ts"
      via: "useAtom hook"
      pattern: "useAtom\\(platformAtom\\)"
    - from: "src/app/globals.css"
      to: "data-platform attribute"
      via: "CSS selectors"
      pattern: "\\[data-platform="
---

<objective>
Implement platform context switching using Jotai for state management, with CSS variable-based theming that changes based on the active platform (Music Vine vs Uppbeat).

Purpose: This enables AUTH-05 (platform context at session level) and AUTH-06 (platform switching via toggle). The color theme changes make platform context immediately obvious per CONTEXT.md decisions.

Output: Jotai atoms in atoms/, providers in providers/, PlatformToggle component, CSS theming
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-and-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-and-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Jotai atoms and providers</name>
  <files>
src/atoms/platformAtom.ts
src/atoms/index.ts
src/providers/JotaiProvider.tsx
src/providers/ThemeProvider.tsx
src/providers/index.ts
  </files>
  <action>
Create Jotai atoms for platform state and providers for proper hydration with Next.js App Router.

**src/atoms/platformAtom.ts:**
```typescript
import { atom } from 'jotai'
import { atomWithStorage } from 'jotai/utils'
import type { Platform, PlatformConfig } from '@/types'
import { PLATFORM_CONFIG } from '@/types/platform'

/**
 * Platform atom with localStorage persistence.
 * Defaults to 'music-vine' if no stored value.
 */
export const platformAtom = atomWithStorage<Platform>('conductor_platform', 'music-vine')

/**
 * Derived atom for current platform configuration.
 */
export const platformConfigAtom = atom((get) => {
  const platform = get(platformAtom)
  return PLATFORM_CONFIG[platform]
})

/**
 * Derived atom for theme colors based on platform.
 */
export const platformThemeAtom = atom((get) => {
  const config = get(platformConfigAtom)
  return config.theme
})

/**
 * Derived atom for API base URL.
 */
export const platformApiBaseAtom = atom((get) => {
  const config = get(platformConfigAtom)
  return config.apiBase
})
```

**src/atoms/index.ts:**
```typescript
export {
  platformAtom,
  platformConfigAtom,
  platformThemeAtom,
  platformApiBaseAtom,
} from './platformAtom'
```

**src/providers/JotaiProvider.tsx:**
```typescript
'use client'

import { Provider } from 'jotai'
import type { ReactNode } from 'react'

interface JotaiProviderProps {
  children: ReactNode
}

/**
 * Jotai Provider wrapper for Next.js App Router.
 *
 * IMPORTANT: Per research, this should NOT be placed in root layout.tsx
 * to avoid hydration issues with Suspense boundaries.
 * Use it in page.tsx or per-route layouts instead.
 */
export function JotaiProvider({ children }: JotaiProviderProps) {
  return <Provider>{children}</Provider>
}
```

**src/providers/ThemeProvider.tsx:**
```typescript
'use client'

import { useAtom } from 'jotai'
import { useEffect, type ReactNode } from 'react'
import { platformAtom } from '@/atoms'

interface ThemeProviderProps {
  children: ReactNode
}

/**
 * Theme Provider that applies platform-specific styling.
 * Sets data-platform attribute on document element for CSS theming.
 */
export function ThemeProvider({ children }: ThemeProviderProps) {
  const [platform] = useAtom(platformAtom)

  useEffect(() => {
    // Set data-platform attribute for CSS theming
    document.documentElement.setAttribute('data-platform', platform)

    // Also update CSS custom properties directly for components
    // that need JS access to colors
    const config = platform === 'music-vine'
      ? { primary: '#1a1a2e', accent: '#16213e' }
      : { primary: '#0f3460', accent: '#533483' }

    document.documentElement.style.setProperty('--platform-primary', config.primary)
    document.documentElement.style.setProperty('--platform-accent', config.accent)
  }, [platform])

  return <>{children}</>
}
```

**src/providers/index.ts:**
```typescript
export { JotaiProvider } from './JotaiProvider'
export { ThemeProvider } from './ThemeProvider'
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. All atoms exported from src/atoms/index.ts
3. All providers exported from src/providers/index.ts
4. Files have 'use client' directive where needed
  </verify>
  <done>
Jotai atoms exist for platform state with localStorage persistence. JotaiProvider and ThemeProvider are created with proper client component directives. All exports are accessible from index files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create PlatformToggle component and CSS theming</name>
  <files>
src/components/PlatformToggle.tsx
src/app/globals.css
  </files>
  <action>
Create the platform toggle component (iOS-style segmented control per CONTEXT.md) and add CSS theming for both platforms.

**src/components/PlatformToggle.tsx:**
```typescript
'use client'

import { useAtom } from 'jotai'
import { platformAtom } from '@/atoms'
import type { Platform } from '@/types'

interface PlatformToggleProps {
  className?: string
}

/**
 * iOS-style segmented control for switching between Music Vine and Uppbeat.
 * Per CONTEXT.md: Located in sidebar, clear visual toggle, preserves current page.
 */
export function PlatformToggle({ className = '' }: PlatformToggleProps) {
  const [platform, setPlatform] = useAtom(platformAtom)

  const handleSwitch = (newPlatform: Platform) => {
    if (newPlatform !== platform) {
      setPlatform(newPlatform)
      // Note: Audit logging for platform switch will be added in Plan 07
    }
  }

  return (
    <div
      role="group"
      aria-label="Platform selector"
      className={`
        inline-flex rounded-lg bg-zinc-100 p-1
        dark:bg-zinc-800
        ${className}
      `}
    >
      <button
        type="button"
        onClick={() => handleSwitch('music-vine')}
        aria-pressed={platform === 'music-vine'}
        className={`
          relative rounded-md px-3 py-1.5 text-sm font-medium
          transition-all duration-200 ease-in-out
          focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2
          ${
            platform === 'music-vine'
              ? 'bg-white text-zinc-900 shadow-sm dark:bg-zinc-700 dark:text-zinc-100'
              : 'text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100'
          }
        `}
      >
        <span className="relative z-10 flex items-center gap-1.5">
          <MusicVineIcon />
          Music Vine
        </span>
      </button>
      <button
        type="button"
        onClick={() => handleSwitch('uppbeat')}
        aria-pressed={platform === 'uppbeat'}
        className={`
          relative rounded-md px-3 py-1.5 text-sm font-medium
          transition-all duration-200 ease-in-out
          focus:outline-none focus-visible:ring-2 focus-visible:ring-offset-2
          ${
            platform === 'uppbeat'
              ? 'bg-white text-zinc-900 shadow-sm dark:bg-zinc-700 dark:text-zinc-100'
              : 'text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-zinc-100'
          }
        `}
      >
        <span className="relative z-10 flex items-center gap-1.5">
          <UppbeatIcon />
          Uppbeat
        </span>
      </button>
    </div>
  )
}

// Simple placeholder icons - can be replaced with actual brand icons later
function MusicVineIcon() {
  return (
    <svg
      className="h-4 w-4"
      viewBox="0 0 24 24"
      fill="currentColor"
      aria-hidden="true"
    >
      <path d="M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z" />
    </svg>
  )
}

function UppbeatIcon() {
  return (
    <svg
      className="h-4 w-4"
      viewBox="0 0 24 24"
      fill="currentColor"
      aria-hidden="true"
    >
      <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
    </svg>
  )
}
```

**Update src/app/globals.css** - Add platform theming CSS variables:

After the existing styles, add:
```css
/* Platform Theming */
:root {
  /* Default to Music Vine theme */
  --platform-primary: #1a1a2e;
  --platform-accent: #16213e;
  --platform-primary-foreground: #ffffff;

  /* Skeleton colors */
  --skeleton-base: #e5e7eb;
  --skeleton-highlight: #f3f4f6;
}

/* Music Vine Theme */
[data-platform='music-vine'] {
  --platform-primary: #1a1a2e;
  --platform-accent: #16213e;
  --platform-primary-foreground: #ffffff;
}

[data-platform='music-vine'] .platform-themed {
  background-color: var(--platform-primary);
  color: var(--platform-primary-foreground);
}

/* Uppbeat Theme */
[data-platform='uppbeat'] {
  --platform-primary: #0f3460;
  --platform-accent: #533483;
  --platform-primary-foreground: #ffffff;
}

[data-platform='uppbeat'] .platform-themed {
  background-color: var(--platform-primary);
  color: var(--platform-primary-foreground);
}

/* Dark mode skeleton colors */
.dark {
  --skeleton-base: #27272a;
  --skeleton-highlight: #3f3f46;
}

/* Platform-aware accent colors for interactive elements */
[data-platform='music-vine'] .platform-accent {
  background-color: var(--platform-accent);
}

[data-platform='uppbeat'] .platform-accent {
  background-color: var(--platform-accent);
}

/* Sidebar platform indicator bar */
.platform-indicator {
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 3px;
  background-color: var(--platform-accent);
  transition: background-color 200ms ease-in-out;
}
```

Make sure the existing imports and styles in globals.css are preserved. Add the skeleton CSS import at the top if not already present:
```css
@import 'react-loading-skeleton/dist/skeleton.css';
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. PlatformToggle component exists and is a client component
3. globals.css has platform theming CSS variables
4. Both [data-platform='music-vine'] and [data-platform='uppbeat'] selectors exist
  </verify>
  <done>
PlatformToggle component exists with iOS-style segmented control UI. CSS theming variables are defined for both platforms. Theme changes are applied via data-platform attribute on document element.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Platform atom can be imported and used: `import { platformAtom } from '@/atoms'`
3. Providers can be imported: `import { JotaiProvider, ThemeProvider } from '@/providers'`
4. PlatformToggle renders two buttons with proper aria attributes
5. CSS variables for both platforms are defined in globals.css
</verification>

<success_criteria>
- Platform state persists in localStorage across browser sessions
- PlatformToggle shows iOS-style segmented control with Music Vine and Uppbeat options
- Switching platforms changes CSS custom properties immediately
- ThemeProvider sets data-platform attribute on document element
- Color themes are distinct between platforms (Music Vine: #1a1a2e, Uppbeat: #0f3460)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-infrastructure/01-04-SUMMARY.md`
</output>
