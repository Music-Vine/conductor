---
phase: 01-foundation-and-infrastructure
plan: 09
type: execute
wave: 4
depends_on: ["01-03", "01-04", "01-05"]
files_modified:
  - src/app/(platform)/layout.tsx
  - src/app/(platform)/layout-client.tsx
  - src/app/(platform)/page.tsx
  - src/components/layout/Sidebar.tsx
  - src/components/layout/Header.tsx
  - src/components/layout/UserMenu.tsx
  - src/components/layout/index.ts
autonomous: true

must_haves:
  truths:
    - "Authenticated pages have consistent shell layout with sidebar"
    - "Platform toggle is visible in sidebar"
    - "User can see their name and log out from header"
    - "Layout adapts to platform theme"
  artifacts:
    - path: "src/app/(platform)/layout.tsx"
      provides: "Platform route group layout"
      exports: ["default"]
    - path: "src/components/layout/Sidebar.tsx"
      provides: "Navigation sidebar"
      exports: ["Sidebar"]
    - path: "src/components/layout/UserMenu.tsx"
      provides: "User profile dropdown with logout"
      exports: ["UserMenu"]
  key_links:
    - from: "src/components/layout/Sidebar.tsx"
      to: "src/components/PlatformToggle.tsx"
      via: "import"
      pattern: "import.*PlatformToggle"
    - from: "src/app/(platform)/layout-client.tsx"
      to: "src/providers"
      via: "provider imports"
      pattern: "import.*from.*providers"
---

<objective>
Create the authenticated app shell with sidebar navigation, header with user menu, and proper provider wrapping.

Purpose: This establishes the visual foundation for all authenticated pages. Per CONTEXT.md, the platform toggle is in the sidebar, and color theme changes based on active platform.

Output: Platform layout in app/(platform)/, layout components in components/layout/
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-and-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-and-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-and-infrastructure/01-03-SUMMARY.md
@.planning/phases/01-foundation-and-infrastructure/01-04-SUMMARY.md
@.planning/phases/01-foundation-and-infrastructure/01-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create layout components</name>
  <files>
src/components/layout/Sidebar.tsx
src/components/layout/Header.tsx
src/components/layout/UserMenu.tsx
src/components/layout/index.ts
  </files>
  <action>
Create the shell layout components for the authenticated area.

**src/components/layout/Sidebar.tsx:**
```typescript
'use client'

import Link from 'next/link'
import { usePathname } from 'next/navigation'
import { PlatformToggle } from '@/components/PlatformToggle'

interface NavItem {
  label: string
  href: string
  icon: React.ReactNode
}

interface SidebarProps {
  userId?: string // For audit logging platform switches
}

// Navigation items will be expanded in Phase 2+
const navItems: NavItem[] = [
  {
    label: 'Dashboard',
    href: '/',
    icon: (
      <svg className="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
        <path strokeLinecap="round" strokeLinejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
      </svg>
    ),
  },
]

export function Sidebar({ userId }: SidebarProps) {
  const pathname = usePathname()

  return (
    <aside className="flex h-screen w-64 flex-col border-r border-zinc-200 bg-white dark:border-zinc-800 dark:bg-zinc-900">
      {/* Platform indicator bar */}
      <div className="platform-indicator" />

      {/* Logo/Brand */}
      <div className="flex h-16 items-center px-6">
        <Link href="/" className="flex items-center gap-2">
          <span className="text-xl font-semibold text-zinc-900 dark:text-zinc-100">
            Conductor
          </span>
        </Link>
      </div>

      {/* Platform Toggle - userId enables audit logging for platform switches */}
      <div className="px-4 pb-4">
        <PlatformToggle className="w-full" userId={userId} />
      </div>

      {/* Navigation */}
      <nav className="flex-1 space-y-1 px-3">
        {navItems.map((item) => {
          const isActive = pathname === item.href
          return (
            <Link
              key={item.href}
              href={item.href}
              className={`
                flex items-center gap-3 rounded-lg px-3 py-2 text-sm font-medium
                transition-colors
                ${
                  isActive
                    ? 'bg-zinc-100 text-zinc-900 dark:bg-zinc-800 dark:text-zinc-100'
                    : 'text-zinc-600 hover:bg-zinc-50 hover:text-zinc-900 dark:text-zinc-400 dark:hover:bg-zinc-800 dark:hover:text-zinc-100'
                }
              `}
            >
              {item.icon}
              {item.label}
            </Link>
          )
        })}
      </nav>

      {/* Footer area for future expansion */}
      <div className="p-4 text-xs text-zinc-400 dark:text-zinc-500">
        Conductor Admin v0.1
      </div>
    </aside>
  )
}
```

**src/components/layout/Header.tsx:**
```typescript
'use client'

import { UserMenu } from './UserMenu'

interface HeaderProps {
  title?: string
  userName: string
  userEmail: string
}

export function Header({ title, userName, userEmail }: HeaderProps) {
  return (
    <header className="flex h-16 items-center justify-between border-b border-zinc-200 bg-white px-6 dark:border-zinc-800 dark:bg-zinc-900">
      <div>
        {title && (
          <h1 className="text-lg font-semibold text-zinc-900 dark:text-zinc-100">
            {title}
          </h1>
        )}
      </div>
      <UserMenu name={userName} email={userEmail} />
    </header>
  )
}
```

**src/components/layout/UserMenu.tsx:**
```typescript
'use client'

import { useState, useRef, useEffect } from 'react'
import { useRouter } from 'next/navigation'

interface UserMenuProps {
  name: string
  email: string
}

export function UserMenu({ name, email }: UserMenuProps) {
  const [isOpen, setIsOpen] = useState(false)
  const menuRef = useRef<HTMLDivElement>(null)
  const router = useRouter()

  // Close menu when clicking outside
  useEffect(() => {
    function handleClickOutside(event: MouseEvent) {
      if (menuRef.current && !menuRef.current.contains(event.target as Node)) {
        setIsOpen(false)
      }
    }

    document.addEventListener('mousedown', handleClickOutside)
    return () => document.removeEventListener('mousedown', handleClickOutside)
  }, [])

  const handleLogout = async () => {
    try {
      await fetch('/api/auth/logout', { method: 'POST' })
      router.push('/login')
    } catch (error) {
      console.error('Logout failed:', error)
      // Still redirect on error - server will handle the cleanup
      router.push('/login')
    }
  }

  // Get initials for avatar
  const initials = name
    .split(' ')
    .map((n) => n[0])
    .join('')
    .toUpperCase()
    .slice(0, 2)

  return (
    <div className="relative" ref={menuRef}>
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="flex items-center gap-3 rounded-lg px-3 py-2 text-sm transition-colors hover:bg-zinc-100 dark:hover:bg-zinc-800"
        aria-expanded={isOpen}
        aria-haspopup="true"
      >
        <span className="hidden text-right sm:block">
          <span className="block font-medium text-zinc-900 dark:text-zinc-100">
            {name}
          </span>
          <span className="block text-xs text-zinc-500 dark:text-zinc-400">
            {email}
          </span>
        </span>
        <span className="flex h-9 w-9 items-center justify-center rounded-full bg-zinc-200 text-sm font-medium text-zinc-700 dark:bg-zinc-700 dark:text-zinc-200">
          {initials}
        </span>
      </button>

      {isOpen && (
        <div className="absolute right-0 mt-2 w-56 origin-top-right rounded-lg border border-zinc-200 bg-white py-1 shadow-lg dark:border-zinc-700 dark:bg-zinc-800">
          <div className="border-b border-zinc-200 px-4 py-3 dark:border-zinc-700">
            <p className="text-sm font-medium text-zinc-900 dark:text-zinc-100">
              {name}
            </p>
            <p className="text-xs text-zinc-500 dark:text-zinc-400">{email}</p>
          </div>
          <button
            onClick={handleLogout}
            className="flex w-full items-center gap-2 px-4 py-2 text-left text-sm text-zinc-700 hover:bg-zinc-100 dark:text-zinc-300 dark:hover:bg-zinc-700"
          >
            <svg
              className="h-4 w-4"
              fill="none"
              viewBox="0 0 24 24"
              stroke="currentColor"
              strokeWidth={2}
            >
              <path
                strokeLinecap="round"
                strokeLinejoin="round"
                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"
              />
            </svg>
            Sign out
          </button>
        </div>
      )}
    </div>
  )
}
```

**src/components/layout/index.ts:**
```typescript
export { Sidebar } from './Sidebar'
export { Header } from './Header'
export { UserMenu } from './UserMenu'
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. All layout components exported from src/components/layout/index.ts
3. Sidebar imports PlatformToggle
4. UserMenu has logout functionality
  </verify>
  <done>
Sidebar with platform toggle and navigation created. Header with UserMenu dropdown created. UserMenu includes logout functionality that calls API and redirects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create platform layout and dashboard page</name>
  <files>
src/app/(platform)/layout.tsx
src/app/(platform)/page.tsx
  </files>
  <action>
Create the platform route group layout that wraps all authenticated pages with providers and shell.

**src/app/(platform)/layout.tsx:**
```typescript
import { cookies } from 'next/headers'
import { redirect } from 'next/navigation'
import { jwtVerify } from 'jose'
import type { SessionPayload } from '@/types'
import { PlatformLayoutClient } from './layout-client'

/**
 * Platform layout for authenticated pages.
 * Server component that validates session and passes user data to client layout.
 */
export default async function PlatformLayout({
  children,
}: {
  children: React.ReactNode
}) {
  // Get session from cookie
  const cookieStore = await cookies()
  const sessionCookie = cookieStore.get('conductor_session')

  if (!sessionCookie?.value) {
    redirect('/login')
  }

  // Validate session
  let session: SessionPayload
  try {
    const secret = new TextEncoder().encode(process.env.SESSION_SECRET)
    const { payload } = await jwtVerify(sessionCookie.value, secret)
    session = payload as unknown as SessionPayload

    // Check expiry
    if (session.expiresAt <= Date.now()) {
      redirect('/login')
    }
  } catch {
    redirect('/login')
  }

  // Get platform from cookie for initial SSR
  const platformCookie = cookieStore.get('conductor_platform')
  const initialPlatform = (platformCookie?.value as 'music-vine' | 'uppbeat') || session.platform

  return (
    <PlatformLayoutClient
      initialPlatform={initialPlatform}
      userName={session.name}
      userEmail={session.email}
      userId={session.userId}
    >
      {children}
    </PlatformLayoutClient>
  )
}
```

Create a client component for the layout since providers need 'use client':

**src/app/(platform)/layout-client.tsx:**
```typescript
'use client'

import { JotaiProvider, ThemeProvider, QueryProvider } from '@/providers'
import { Sidebar, Header } from '@/components/layout'
import type { Platform } from '@/types'

interface PlatformLayoutClientProps {
  children: React.ReactNode
  initialPlatform: Platform
  userName: string
  userEmail: string
  userId: string
}

/**
 * Client layout with providers for authenticated pages.
 */
export function PlatformLayoutClient({
  children,
  initialPlatform,
  userName,
  userEmail,
  userId,
}: PlatformLayoutClientProps) {
  return (
    <JotaiProvider>
      <QueryProvider>
        <ThemeProvider>
          <div className="flex h-screen bg-zinc-50 dark:bg-zinc-950">
            <Sidebar userId={userId} />
            <div className="flex flex-1 flex-col overflow-hidden">
              <Header userName={userName} userEmail={userEmail} />
              <main className="flex-1 overflow-auto p-6">
                {children}
              </main>
            </div>
          </div>
        </ThemeProvider>
      </QueryProvider>
    </JotaiProvider>
  )
}
```

**src/app/(platform)/page.tsx:**
```typescript
/**
 * Dashboard home page.
 * Placeholder content for Phase 1 - will be expanded in later phases.
 */
export default function DashboardPage() {
  return (
    <div className="space-y-6">
      <div>
        <h1 className="text-2xl font-semibold text-zinc-900 dark:text-zinc-100">
          Dashboard
        </h1>
        <p className="mt-1 text-zinc-600 dark:text-zinc-400">
          Welcome to Conductor Admin
        </p>
      </div>

      <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
        {/* Placeholder cards for future dashboard content */}
        <DashboardCard
          title="Users"
          description="Manage user accounts"
          href="/users"
          count="—"
        />
        <DashboardCard
          title="Assets"
          description="Manage catalog assets"
          href="/assets"
          count="—"
        />
        <DashboardCard
          title="Contributors"
          description="Manage contributors"
          href="/contributors"
          count="—"
        />
      </div>

      <div className="rounded-lg border border-zinc-200 bg-white p-6 dark:border-zinc-800 dark:bg-zinc-900">
        <h2 className="text-lg font-medium text-zinc-900 dark:text-zinc-100">
          Phase 1 Complete
        </h2>
        <p className="mt-2 text-sm text-zinc-600 dark:text-zinc-400">
          Foundation infrastructure is in place. Authentication, platform switching,
          audit logging, and form validation are all functional.
        </p>
        <ul className="mt-4 space-y-2 text-sm text-zinc-600 dark:text-zinc-400">
          <li>• Session-based authentication with magic links</li>
          <li>• Platform context switching (Music Vine / Uppbeat)</li>
          <li>• Audit event logging</li>
          <li>• Form validation with visual feedback</li>
          <li>• Loading skeletons and error boundaries</li>
        </ul>
      </div>
    </div>
  )
}

interface DashboardCardProps {
  title: string
  description: string
  href: string
  count: string
}

function DashboardCard({ title, description, href, count }: DashboardCardProps) {
  return (
    <a
      href={href}
      className="group block rounded-lg border border-zinc-200 bg-white p-6 transition-shadow hover:shadow-md dark:border-zinc-800 dark:bg-zinc-900"
    >
      <div className="flex items-center justify-between">
        <h3 className="font-medium text-zinc-900 group-hover:text-zinc-700 dark:text-zinc-100 dark:group-hover:text-zinc-300">
          {title}
        </h3>
        <span className="text-2xl font-semibold text-zinc-900 dark:text-zinc-100">
          {count}
        </span>
      </div>
      <p className="mt-1 text-sm text-zinc-500 dark:text-zinc-400">
        {description}
      </p>
    </a>
  )
}
```
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Platform layout exists at src/app/(platform)/layout.tsx
3. Client layout wraps children with all required providers
4. Dashboard page exists at src/app/(platform)/page.tsx
  </verify>
  <done>
Platform layout validates session server-side and passes user data to client layout. Client layout wraps content with JotaiProvider, QueryProvider, ThemeProvider. Dashboard placeholder page shows Phase 1 completion summary.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. Visiting / while authenticated shows dashboard with sidebar
3. Platform toggle appears in sidebar
4. User menu shows name, email, and logout option
5. Platform theme changes are visible when toggling
</verification>

<success_criteria>
- Authenticated pages have consistent shell layout with sidebar and header
- Platform toggle is visible and functional in sidebar
- User can see their name and email in header
- User can log out from header dropdown
- Layout adapts to platform theme (CSS variables)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-infrastructure/01-09-SUMMARY.md`
</output>
