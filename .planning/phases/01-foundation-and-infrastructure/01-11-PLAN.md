---
phase: 01-foundation-and-infrastructure
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/PlatformToggle.tsx
  - src/app/(platform)/loading.tsx
  - src/app/(platform)/settings/page.tsx
  - src/app/(platform)/settings/loading.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Platform switches are logged to audit API"
    - "Dashboard shows skeleton cards while loading"
    - "Settings form validates on blur with visual feedback"
  artifacts:
    - path: "src/components/PlatformToggle.tsx"
      provides: "Platform toggle with active audit logging"
      contains: "captureAuditEvent"
    - path: "src/app/(platform)/loading.tsx"
      provides: "Dashboard loading state with skeletons"
      contains: "CardSkeleton"
    - path: "src/app/(platform)/settings/page.tsx"
      provides: "Settings page demonstrating form validation"
      contains: "Form"
  key_links:
    - from: "src/components/PlatformToggle.tsx"
      to: "/api/audit"
      via: "captureAuditEvent"
      pattern: "captureAuditEvent"
    - from: "src/app/(platform)/loading.tsx"
      to: "src/components/skeletons/CardSkeleton.tsx"
      via: "import"
      pattern: "import.*CardSkeleton"
    - from: "src/app/(platform)/settings/page.tsx"
      to: "src/components/forms/Form.tsx"
      via: "import"
      pattern: "import.*Form"
---

<objective>
Close Phase 1 verification gaps by enabling audit logging, demonstrating skeleton loading states, and showcasing form validation.

Purpose: Address 3 gaps identified in verification - audit logging disabled, skeletons unused, form validation not demonstrated
Output: PlatformToggle with active audit, dashboard loading.tsx with skeletons, settings page with validated form
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-and-infrastructure/01-VERIFICATION.md

Reference existing code:
@src/components/PlatformToggle.tsx
@src/lib/audit/logger.ts
@src/components/skeletons/CardSkeleton.tsx
@src/components/forms/Form.tsx
@src/components/forms/FormInput.tsx
@src/lib/validation/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable audit logging in PlatformToggle</name>
  <files>src/components/PlatformToggle.tsx</files>
  <action>
    Fix the PlatformToggle component to actively log platform switches:

    1. Remove the TODO comment on line 27 that says "Enable when audit module is implemented"
    2. Replace the silent catch block (lines 42-45) with proper error logging:
       ```typescript
       .catch((error) => {
         // Log audit failures to console - don't throw to avoid breaking toggle
         console.error('Failed to log platform switch:', error)
       })
       ```
    3. The audit infrastructure is already implemented (01-07), so this just enables it

    The code path is correct, just needs the TODO removed and catch to log errors instead of silent fail.
  </action>
  <verify>
    1. Run `npm run build` - should compile without errors
    2. Search for TODO in PlatformToggle: `grep -n "TODO" src/components/PlatformToggle.tsx` - should return empty
    3. Verify catch logs error: `grep -A1 ".catch" src/components/PlatformToggle.tsx` - should show console.error
  </verify>
  <done>PlatformToggle actively logs platform switches to audit API with error handling that logs failures</done>
</task>

<task type="auto">
  <name>Task 2: Add dashboard loading skeleton</name>
  <files>src/app/(platform)/loading.tsx</files>
  <action>
    Create a loading.tsx file in the (platform) route group that displays skeleton cards while the dashboard loads:

    ```typescript
    import { CardSkeleton } from '@/components/skeletons/CardSkeleton'

    /**
     * Dashboard loading state - shows skeleton cards matching dashboard layout.
     * Uses Next.js loading.tsx convention for automatic Suspense boundary.
     */
    export default function DashboardLoading() {
      return (
        <div className="space-y-6">
          {/* Header skeleton */}
          <div>
            <div className="h-8 w-48 animate-pulse rounded bg-zinc-200 dark:bg-zinc-800" />
            <div className="mt-2 h-5 w-64 animate-pulse rounded bg-zinc-200 dark:bg-zinc-800" />
          </div>

          {/* Card grid skeleton - matches DashboardCard layout */}
          <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
            <CardSkeleton lines={2} />
            <CardSkeleton lines={2} />
            <CardSkeleton lines={2} />
          </div>

          {/* Info section skeleton */}
          <div className="rounded-lg border border-zinc-200 bg-white p-6 dark:border-zinc-800 dark:bg-zinc-900">
            <div className="h-6 w-40 animate-pulse rounded bg-zinc-200 dark:bg-zinc-800" />
            <div className="mt-3 space-y-2">
              <div className="h-4 w-full animate-pulse rounded bg-zinc-200 dark:bg-zinc-800" />
              <div className="h-4 w-3/4 animate-pulse rounded bg-zinc-200 dark:bg-zinc-800" />
            </div>
          </div>
        </div>
      )
    }
    ```

    This demonstrates skeleton usage and provides proper loading state for the dashboard route.
  </action>
  <verify>
    1. File exists: `ls src/app/(platform)/loading.tsx`
    2. Imports CardSkeleton: `grep "CardSkeleton" src/app/(platform)/loading.tsx`
    3. Runs without errors: `npm run build`
  </verify>
  <done>Dashboard has loading.tsx that displays CardSkeleton components while page loads</done>
</task>

<task type="auto">
  <name>Task 3: Create settings page with form validation</name>
  <files>src/app/(platform)/settings/page.tsx, src/app/(platform)/settings/loading.tsx</files>
  <action>
    Create a settings page that demonstrates the Form validation components working:

    1. Create src/app/(platform)/settings/page.tsx:
    ```typescript
    'use client'

    import { Form } from '@/components/forms/Form'
    import { FormInput } from '@/components/forms/FormInput'
    import { z } from 'zod'
    import { useState } from 'react'

    // Validation schema for profile settings
    const profileSchema = z.object({
      name: z.string()
        .min(2, 'Name must be at least 2 characters')
        .max(50, 'Name must be less than 50 characters'),
      email: z.string()
        .email('Please enter a valid email address'),
    })

    type ProfileFormData = z.infer<typeof profileSchema>

    /**
     * Settings page demonstrating form validation.
     * Uses Form + FormInput components with onBlur validation.
     */
    export default function SettingsPage() {
      const [submitted, setSubmitted] = useState(false)

      const handleSubmit = (data: ProfileFormData) => {
        console.log('Form submitted:', data)
        setSubmitted(true)
        // In real implementation, this would call API
        setTimeout(() => setSubmitted(false), 3000)
      }

      return (
        <div className="space-y-6">
          <div>
            <h1 className="text-2xl font-semibold text-zinc-900 dark:text-zinc-100">
              Settings
            </h1>
            <p className="mt-1 text-zinc-600 dark:text-zinc-400">
              Update your profile settings
            </p>
          </div>

          <div className="max-w-md rounded-lg border border-zinc-200 bg-white p-6 dark:border-zinc-800 dark:bg-zinc-900">
            <h2 className="mb-4 text-lg font-medium text-zinc-900 dark:text-zinc-100">
              Profile Information
            </h2>

            {submitted && (
              <div className="mb-4 rounded-lg bg-green-50 p-3 text-sm text-green-700 dark:bg-green-900/20 dark:text-green-400">
                Settings saved successfully
              </div>
            )}

            <Form
              schema={profileSchema}
              defaultValues={{ name: '', email: '' }}
              onSubmit={handleSubmit}
              className="space-y-4"
            >
              <FormInput
                name="name"
                label="Display Name"
                placeholder="Your name"
                autoComplete="name"
              />

              <FormInput
                name="email"
                label="Email Address"
                type="email"
                placeholder="you@example.com"
                autoComplete="email"
              />

              <div className="pt-2">
                <button
                  type="submit"
                  className="w-full rounded-lg bg-zinc-900 px-4 py-2.5 text-sm font-medium text-white transition-colors hover:bg-zinc-800 focus:outline-none focus:ring-2 focus:ring-zinc-500/20 focus:ring-offset-2 dark:bg-zinc-100 dark:text-zinc-900 dark:hover:bg-zinc-200"
                >
                  Save Changes
                </button>
              </div>
            </Form>

            <p className="mt-4 text-xs text-zinc-500 dark:text-zinc-400">
              Try leaving fields empty or entering invalid data to see validation in action.
              Validation fires on blur (when you leave a field).
            </p>
          </div>
        </div>
      )
    }
    ```

    2. Create src/app/(platform)/settings/loading.tsx:
    ```typescript
    import { FormSkeleton } from '@/components/skeletons/FormSkeleton'

    export default function SettingsLoading() {
      return (
        <div className="space-y-6">
          <div>
            <div className="h-8 w-32 animate-pulse rounded bg-zinc-200 dark:bg-zinc-800" />
            <div className="mt-2 h-5 w-48 animate-pulse rounded bg-zinc-200 dark:bg-zinc-800" />
          </div>
          <div className="max-w-md">
            <FormSkeleton fields={2} />
          </div>
        </div>
      )
    }
    ```

    This demonstrates:
    - Form component with Zod schema validation
    - FormInput with onBlur validation (mode: 'onBlur' in Form.tsx)
    - Visual feedback: red border + error icon on invalid, green checkmark on valid
    - Error messages inline below fields
  </action>
  <verify>
    1. Files exist: `ls src/app/(platform)/settings/`
    2. Settings page imports Form: `grep "import.*Form" src/app/(platform)/settings/page.tsx`
    3. Uses FormInput: `grep "FormInput" src/app/(platform)/settings/page.tsx`
    4. Loading uses FormSkeleton: `grep "FormSkeleton" src/app/(platform)/settings/loading.tsx`
    5. Build succeeds: `npm run build`
  </verify>
  <done>Settings page exists with Form validation that validates on blur and shows visual feedback (red border + error icon on invalid, green checkmark on valid)</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Audit logging works:**
   - Start dev server: `npm run dev`
   - Log in and navigate to dashboard
   - Open browser DevTools Network tab
   - Click platform toggle (switch between Music Vine/Uppbeat)
   - Verify POST request to /api/audit with platform.switched action
   - Check console for any error messages (should be none)

2. **Skeleton loading visible:**
   - Hard refresh dashboard page
   - Should briefly see skeleton cards (may need to throttle network in DevTools to see)
   - Loading state matches dashboard layout structure

3. **Form validation works:**
   - Navigate to /settings
   - Click into Name field, then click out without entering text
   - Should see red border, error icon, and "Name must be at least 2 characters" message
   - Enter valid name (2+ chars), click out - should see green checkmark
   - Test email field with invalid email - should show validation error
   - Enter valid email - should see green checkmark
   - Submit form with valid data - should see success message
</verification>

<success_criteria>
- [ ] PlatformToggle has no TODO comments related to audit
- [ ] PlatformToggle catch block logs errors instead of silent fail
- [ ] Platform switches create audit events in /api/audit
- [ ] src/app/(platform)/loading.tsx exists and uses CardSkeleton
- [ ] src/app/(platform)/settings/page.tsx exists with Form + FormInput
- [ ] Settings form validates on blur (leave field â†’ validation fires)
- [ ] Invalid fields show red border + error icon
- [ ] Valid fields show green checkmark (after being touched)
- [ ] All Phase 1 verification gaps are closed
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-infrastructure/01-11-SUMMARY.md`
</output>
