---
phase: 01-foundation-and-infrastructure
plan: 11
type: execute
wave: 2
depends_on: [12]
files_modified:
  - src/components/PlatformToggle.tsx
  - src/app/(platform)/loading.tsx
  - src/app/(platform)/settings/page.tsx
  - src/app/(platform)/settings/loading.tsx
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Platform switches are logged to audit API"
    - "Dashboard shows Cadence Skeleton components while loading"
    - "Settings form validates on blur with Cadence UI components"
  artifacts:
    - path: "src/components/PlatformToggle.tsx"
      provides: "Platform toggle with active audit logging"
      contains: "captureAuditEvent"
    - path: "src/app/(platform)/loading.tsx"
      provides: "Dashboard loading state with Cadence skeletons"
      contains: "@music-vine/cadence/ui"
    - path: "src/app/(platform)/settings/page.tsx"
      provides: "Settings page using Cadence form components"
      contains: "@music-vine/cadence/ui"
  key_links:
    - from: "src/components/PlatformToggle.tsx"
      to: "/api/audit"
      via: "captureAuditEvent"
      pattern: "captureAuditEvent"
    - from: "src/app/(platform)/loading.tsx"
      to: "@music-vine/cadence/ui"
      via: "import"
      pattern: "import.*Skeleton.*from '@music-vine/cadence/ui'"
    - from: "src/app/(platform)/settings/page.tsx"
      to: "@music-vine/cadence/ui"
      via: "import"
      pattern: "import.*from '@music-vine/cadence/ui'"
---

<objective>
Close Phase 1 verification gaps by enabling audit logging, demonstrating skeleton loading states, and showcasing form validation.

Purpose: Address 3 gaps identified in verification - audit logging disabled, skeletons unused, form validation not demonstrated
Output: PlatformToggle with active audit, dashboard loading.tsx with skeletons, settings page with validated form
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/01-foundation-and-infrastructure/01-VERIFICATION.md

Reference existing code:
@src/components/PlatformToggle.tsx
@src/lib/audit/logger.ts
@src/components/skeletons/CardSkeleton.tsx
@src/components/forms/Form.tsx
@src/components/forms/FormInput.tsx
@src/lib/validation/schemas.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enable audit logging in PlatformToggle</name>
  <files>src/components/PlatformToggle.tsx</files>
  <action>
    Fix the PlatformToggle component to actively log platform switches:

    1. Remove the TODO comment on line 27 that says "Enable when audit module is implemented"
    2. Replace the silent catch block (lines 42-45) with proper error logging:
       ```typescript
       .catch((error) => {
         // Log audit failures to console - don't throw to avoid breaking toggle
         console.error('Failed to log platform switch:', error)
       })
       ```
    3. The audit infrastructure is already implemented (01-07), so this just enables it

    The code path is correct, just needs the TODO removed and catch to log errors instead of silent fail.
  </action>
  <verify>
    1. Run `npm run build` - should compile without errors
    2. Search for TODO in PlatformToggle: `grep -n "TODO" src/components/PlatformToggle.tsx` - should return empty
    3. Verify catch logs error: `grep -A1 ".catch" src/components/PlatformToggle.tsx` - should show console.error
  </verify>
  <done>PlatformToggle actively logs platform switches to audit API with error handling that logs failures</done>
</task>

<task type="auto">
  <name>Task 2: Add dashboard loading skeleton using Cadence</name>
  <files>src/app/(platform)/loading.tsx</files>
  <action>
    Create a loading.tsx file in the (platform) route group using Cadence Skeleton components:

    ```typescript
    import { Card, CardHeader, CardContent, Skeleton } from '@music-vine/cadence/ui'

    /**
     * Dashboard loading state - shows Cadence Skeleton components matching dashboard layout.
     * Uses Next.js loading.tsx convention for automatic Suspense boundary.
     */
    export default function DashboardLoading() {
      return (
        <div className="space-y-6">
          {/* Header skeleton */}
          <div>
            <Skeleton className="h-8 w-48" />
            <Skeleton className="mt-2 h-5 w-64" />
          </div>

          {/* Card grid skeleton - matches DashboardCard layout */}
          <div className="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
            {[1, 2, 3].map((i) => (
              <Card key={i}>
                <CardHeader>
                  <Skeleton className="h-5 w-32" />
                  <Skeleton className="mt-2 h-4 w-24" />
                </CardHeader>
                <CardContent>
                  <Skeleton className="h-4 w-full" />
                  <Skeleton className="mt-2 h-4 w-3/4" />
                </CardContent>
              </Card>
            ))}
          </div>

          {/* Info section skeleton */}
          <Card>
            <CardContent className="p-6">
              <Skeleton className="h-6 w-40" />
              <div className="mt-3 space-y-2">
                <Skeleton className="h-4 w-full" />
                <Skeleton className="h-4 w-3/4" />
              </div>
            </CardContent>
          </Card>
        </div>
      )
    }
    ```

    This demonstrates Cadence Skeleton and Card components in a real loading state.
  </action>
  <verify>
    1. File exists: `ls src/app/(platform)/loading.tsx`
    2. Imports Cadence components: `grep "@music-vine/cadence/ui" src/app/(platform)/loading.tsx`
    3. Runs without errors: `npm run build`
  </verify>
  <done>Dashboard has loading.tsx that displays Cadence Skeleton components while page loads</done>
</task>

<task type="auto">
  <name>Task 3: Create settings page with Cadence form components</name>
  <files>src/app/(platform)/settings/page.tsx, src/app/(platform)/settings/loading.tsx</files>
  <action>
    Create a settings page using Cadence UI components with React Hook Form validation:

    1. Create src/app/(platform)/settings/page.tsx:
    ```typescript
    'use client'

    import { Card, CardHeader, CardContent, Button, Heading, Text } from '@music-vine/cadence/ui'
    import { Form } from '@/components/forms/Form'
    import { FormInput } from '@/components/forms/FormInput'
    import { z } from 'zod'
    import { useState } from 'react'

    // Validation schema for profile settings
    const profileSchema = z.object({
      name: z.string()
        .min(2, 'Name must be at least 2 characters')
        .max(50, 'Name must be less than 50 characters'),
      email: z.string()
        .email('Please enter a valid email address'),
    })

    type ProfileFormData = z.infer<typeof profileSchema>

    /**
     * Settings page demonstrating form validation with Cadence components.
     * Uses custom Form wrapper (React Hook Form + Zod) with Cadence Input components.
     */
    export default function SettingsPage() {
      const [submitted, setSubmitted] = useState(false)

      const handleSubmit = (data: ProfileFormData) => {
        console.log('Form submitted:', data)
        setSubmitted(true)
        // In real implementation, this would call API
        setTimeout(() => setSubmitted(false), 3000)
      }

      return (
        <div className="space-y-6">
          <div>
            <Heading as="h1">Settings</Heading>
            <Text className="mt-1">Update your profile settings</Text>
          </div>

          <Card className="max-w-md">
            <CardHeader>
              <Heading as="h2" size="md">Profile Information</Heading>
            </CardHeader>
            <CardContent>
              {submitted && (
                <div className="mb-4 rounded-lg bg-green-50 p-3 text-sm text-green-700 dark:bg-green-900/20 dark:text-green-400">
                  Settings saved successfully
                </div>
              )}

              <Form
                schema={profileSchema}
                defaultValues={{ name: '', email: '' }}
                onSubmit={handleSubmit}
                className="space-y-4"
              >
                <FormInput
                  name="name"
                  label="Display Name"
                  placeholder="Your name"
                  autoComplete="name"
                />

                <FormInput
                  name="email"
                  label="Email Address"
                  type="email"
                  placeholder="you@example.com"
                  autoComplete="email"
                />

                <div className="pt-2">
                  <Button type="submit" className="w-full">
                    Save Changes
                  </Button>
                </div>
              </Form>

              <Text size="sm" className="mt-4">
                Try leaving fields empty or entering invalid data to see validation in action.
                Validation fires on blur (when you leave a field).
              </Text>
            </CardContent>
          </Card>
        </div>
      )
    }
    ```

    2. Create src/app/(platform)/settings/loading.tsx:
    ```typescript
    import { Card, CardHeader, CardContent, Skeleton } from '@music-vine/cadence/ui'

    export default function SettingsLoading() {
      return (
        <div className="space-y-6">
          <div>
            <Skeleton className="h-8 w-32" />
            <Skeleton className="mt-2 h-5 w-48" />
          </div>
          <Card className="max-w-md">
            <CardHeader>
              <Skeleton className="h-6 w-48" />
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div>
                  <Skeleton className="mb-2 h-4 w-24" />
                  <Skeleton className="h-10 w-full" />
                </div>
                <div>
                  <Skeleton className="mb-2 h-4 w-24" />
                  <Skeleton className="h-10 w-full" />
                </div>
                <Skeleton className="h-10 w-full" />
              </div>
            </CardContent>
          </Card>
        </div>
      )
    }
    ```

    This demonstrates:
    - Cadence Card, Heading, Text, Button components
    - Form wrapper (React Hook Form + Zod) with Cadence-wrapped Input components
    - FormInput uses Cadence Input under the hood (refactored in plan 12)
    - Visual feedback via Cadence styles (red border + error icon on invalid, green checkmark on valid)
  </action>
  <verify>
    1. Files exist: `ls src/app/(platform)/settings/`
    2. Settings page imports Cadence: `grep "@music-vine/cadence/ui" src/app/(platform)/settings/page.tsx`
    3. Uses Form wrapper: `grep "import.*Form" src/app/(platform)/settings/page.tsx`
    4. Uses FormInput: `grep "FormInput" src/app/(platform)/settings/page.tsx`
    5. Loading uses Cadence Skeleton: `grep "Skeleton.*from '@music-vine/cadence/ui'" src/app/(platform)/settings/loading.tsx`
    6. Build succeeds: `npm run build`
  </verify>
  <done>Settings page exists using Cadence components (Card, Button, Heading, Text) with form validation that validates on blur</done>
</task>

</tasks>

<verification>
After all tasks complete, verify:

1. **Audit logging works:**
   - Start dev server: `npm run dev`
   - Log in and navigate to dashboard
   - Open browser DevTools Network tab
   - Click platform toggle (switch between Music Vine/Uppbeat)
   - Verify POST request to /api/audit with platform.switched action
   - Check console for any error messages (should be none)

2. **Cadence Skeleton loading visible:**
   - Hard refresh dashboard page
   - Should briefly see Cadence Skeleton components in Cards (may need to throttle network in DevTools to see)
   - Loading state uses Cadence Card and Skeleton components
   - Verify imports come from @music-vine/cadence/ui

3. **Form validation works with Cadence:**
   - Navigate to /settings
   - Page should use Cadence Card, Button, Heading, Text components
   - Click into Name field, then click out without entering text
   - Should see red border, error icon, and "Name must be at least 2 characters" message
   - Enter valid name (2+ chars), click out - should see green checkmark
   - Test email field with invalid email - should show validation error
   - Enter valid email - should see green checkmark
   - Submit form with valid data - should see success message
   - All UI components (except form wrappers) should come from Cadence
</verification>

<success_criteria>
- [ ] PlatformToggle has no TODO comments related to audit
- [ ] PlatformToggle catch block logs errors instead of silent fail
- [ ] Platform switches create audit events in /api/audit
- [ ] src/app/(platform)/loading.tsx exists and imports from @music-vine/cadence/ui
- [ ] Dashboard loading uses Cadence Skeleton and Card components
- [ ] src/app/(platform)/settings/page.tsx exists and imports from @music-vine/cadence/ui
- [ ] Settings page uses Cadence Card, Button, Heading, Text components
- [ ] Settings form validates on blur (leave field â†’ validation fires)
- [ ] FormInput components use Cadence Input primitives (after plan 12)
- [ ] Invalid fields show red border + error icon (via Cadence styles)
- [ ] Valid fields show green checkmark (via Cadence-wrapped FormField)
- [ ] All Phase 1 verification gaps are closed with Cadence components
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-infrastructure/01-11-SUMMARY.md`
</output>
