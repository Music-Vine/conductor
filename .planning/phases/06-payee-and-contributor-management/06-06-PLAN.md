---
phase: 06-payee-and-contributor-management
plan: 06
type: execute
wave: 4
depends_on: ["06-04", "06-05"]
files_modified:
  - src/app/(platform)/contributors/new/page.tsx
  - src/app/(platform)/contributors/components/ContributorForm.tsx
  - src/app/(platform)/contributors/[id]/components/PayeesTab.tsx
  - src/app/(platform)/contributors/[id]/components/PayeeAssignmentForm.tsx
  - src/app/(platform)/payees/new/page.tsx
  - src/app/(platform)/payees/components/PayeeForm.tsx
autonomous: true

must_haves:
  truths:
    - "Staff can add a new contributor with name, email, phone, and address"
    - "Staff can add a new payee with name, email, payment method, and payment details"
    - "Staff can assign payees to a contributor with percentage rates"
    - "Payee rates are validated to sum to exactly 100% before submission"
    - "Staff can see remaining percentage in real-time as they assign rates"
    - "Staff can add and remove payee rows in the assignment form"
  artifacts:
    - path: "src/app/(platform)/contributors/new/page.tsx"
      provides: "Add new contributor form page"
      contains: "ContributorForm"
    - path: "src/app/(platform)/contributors/[id]/components/PayeeAssignmentForm.tsx"
      provides: "Form for assigning payees with percentage rates"
      contains: "useFieldArray"
    - path: "src/app/(platform)/payees/new/page.tsx"
      provides: "Add new payee form page"
      contains: "PayeeForm"
  key_links:
    - from: "src/app/(platform)/contributors/[id]/components/PayeeAssignmentForm.tsx"
      to: "src/lib/validation/financial.ts"
      via: "zodResolver with contributorPayeesSchema"
      pattern: "contributorPayeesSchema"
    - from: "src/app/(platform)/contributors/[id]/components/PayeeAssignmentForm.tsx"
      to: "src/lib/api/contributors.ts"
      via: "saveContributorPayees mutation"
      pattern: "saveContributorPayees"
    - from: "src/app/(platform)/contributors/new/page.tsx"
      to: "src/lib/api/contributors.ts"
      via: "createContributor mutation"
      pattern: "createContributor"
---

<objective>
Create forms for adding contributors, adding payees, and assigning payees to contributors with percentage rate validation.

Purpose: Implement the core financial management workflows: creating contributors (PAYE-01), creating payees, setting payout percentage rates (PAYE-02), and assigning payees to contributors (PAYE-03). The payee assignment form is the centerpiece - it uses useFieldArray for dynamic payee rows with real-time percentage validation.
Output: Working forms for contributor creation, payee creation, and payee assignment with 100% rate validation.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-payee-and-contributor-management/06-RESEARCH.md
@src/lib/validation/financial.ts
@src/lib/api/contributors.ts
@src/lib/api/payees.ts
@src/app/(platform)/contributors/[id]/components/PayeesTab.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create contributor and payee creation forms</name>
  <files>src/app/(platform)/contributors/new/page.tsx, src/app/(platform)/contributors/components/ContributorForm.tsx, src/app/(platform)/payees/new/page.tsx, src/app/(platform)/payees/components/PayeeForm.tsx</files>
  <action>
Create forms for adding new contributors and payees following Phase 1 form validation patterns (react-hook-form + zod).

**ContributorForm.tsx:** Reusable form component
- Uses react-hook-form with zodResolver(contributorSchema)
- Fields: Name (required), Email (required), Phone (optional), Tax ID (optional)
- Address section (optional, collapsible): Street, City, State, ZIP, Country
- All inputs use Cadence Input component where possible
- Blur validation with onChange after first error (Phase 1 pattern)
- Submit button: variant="bold", text "Add Contributor" or "Save Changes" based on mode prop
- Cancel button: variant="subtle", navigates back
- Props: onSubmit, initialData? (for edit mode), isSubmitting

**contributors/new/page.tsx:** Page wrapper
- Simple page with header "Add Contributor" and "Back to Contributors" link
- Uses ContributorForm component
- On submit: call createContributor API, show success toast, redirect to /contributors/[id]
- On error: show error toast with API error message

**PayeeForm.tsx:** Reusable form component
- Uses react-hook-form with zodResolver(payeeSchema)
- Fields: Name (required), Email (required), Phone (optional)
- Payment Method: Select dropdown (ACH, Wire, Check, PayPal)
- Conditional payment details based on method:
  - ACH: Account Number + Routing Number fields
  - Wire: Account Number + Routing Number fields
  - Check: No additional fields
  - PayPal: PayPal Email field
- Tax ID (optional)
- Address section (optional, collapsible)
- Same validation pattern as ContributorForm

**payees/new/page.tsx:** Page wrapper
- Header "Add Payee" with back link
- Uses PayeeForm component
- On submit: call createPayee API, success toast, redirect to /payees/[id]
  </action>
  <verify>Run `npx tsc --noEmit`. Visit /contributors/new - verify form renders with validation. Submit with empty name - verify error message. Fill required fields and submit - verify success toast and redirect. Same for /payees/new.</verify>
  <done>Contributor and payee creation forms validate input, submit to API, show success/error feedback, and redirect on success.</done>
</task>

<task type="auto">
  <name>Task 2: Create payee assignment form with percentage rate validation</name>
  <files>src/app/(platform)/contributors/[id]/components/PayeeAssignmentForm.tsx, src/app/(platform)/contributors/[id]/components/PayeesTab.tsx</files>
  <action>
Create the payee assignment form - the core financial management component. This form allows staff to assign multiple payees to a contributor with percentage rates that must sum to 100%.

**PayeeAssignmentForm.tsx:** Dynamic form with useFieldArray
- Uses react-hook-form with zodResolver(contributorPayeesSchema)
- useFieldArray for dynamic payee rows (name: 'payees')
- Props: contributorId, existingPayees (for edit), availablePayees (for dropdown), onSubmit, onCancel

Each payee row contains:
- Payee selector: Select dropdown populated with availablePayees. Disable already-selected payees in other rows to prevent duplicates.
- Percentage Rate: Number input (type="number", min=0, max=100, step=1) with "%" suffix. Use integer values only.
- Effective Date: Date input (type="date"), default to today
- Notes: Optional text input
- Remove button (only if more than one row): Cadence Button variant="subtle" size="sm"

Real-time percentage tracking:
- Watch all payee rates with `watch('payees')`
- Calculate totalPercentage = sum of all rates
- Display at top of form with color coding:
  - Green (text-green-600): exactly 100%
  - Yellow (text-yellow-600): under 100%, show "X% remaining to allocate"
  - Red (text-red-600): over 100%, show "Over by X%"
- Submit button disabled when total !== 100%

"Add Payee" button:
- Appends new row with default percentage = remaining (100 - current total, min 0)
- Default effective date = today

Form actions:
- "Save Assignments" button: variant="bold", disabled when total !== 100% or form invalid
- "Cancel" button: variant="subtle"
- On submit: call saveContributorPayees(contributorId, payees)
- Success: toast "Payee assignments saved", call router.refresh()
- Error: toast with error message

**Update PayeesTab.tsx:**
- Replace the placeholder toast buttons with actual functionality
- Add state for showing/hiding PayeeAssignmentForm
- "Add Payee" and "Edit Rate" buttons open the form in a modal or inline section
- "Remove" button shows confirmation dialog (use Radix AlertDialog), then removes the payee and re-saves remaining payees
- Fetch available payees list (use fetchPayees with no filters to get all payees for dropdown)
- When form is saved, refresh the payees data

Wire it up:
- PayeesTab renders PayeeAssignmentForm when user clicks "Edit Assignments" or "Add Payee"
- Form prefills with existing payee assignments
- On save, refetch payee data using router.refresh()
  </action>
  <verify>Run `npx tsc --noEmit`. Visit /contributors/contrib-001, click Payees tab. Click "Edit Assignments" - verify form appears with existing payees pre-filled. Change a rate - verify total updates in real-time. Try submitting with total !== 100% - verify button is disabled. Add a payee row - verify remaining percentage auto-fills.</verify>
  <done>Payee assignment form dynamically adds/removes payee rows, validates percentage sum to 100% in real-time, disables submit when invalid, and saves assignments via API. PayeesTab integrated with form for CRUD operations.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes
2. /contributors/new form creates contributor with validation
3. /payees/new form creates payee with conditional payment detail fields
4. Payee assignment form shows real-time percentage total
5. Cannot submit when rates don't sum to 100%
6. Add payee row auto-fills remaining percentage
7. Existing assignments pre-fill form correctly
8. Save refreshes the payees tab with updated data
</verification>

<success_criteria>
- Staff can create contributors and payees with validated forms
- Payee assignment form enforces 100% rate sum with real-time visual feedback
- Dynamic payee rows can be added/removed with percentage auto-adjustment
- All form submissions show success/error feedback via toast
</success_criteria>

<output>
After completion, create `.planning/phases/06-payee-and-contributor-management/06-06-SUMMARY.md`
</output>
