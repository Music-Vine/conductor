---
phase: 04-catalog-management
plan: 15
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/asset/AudioWaveformPlayer.tsx
  - src/app/api/assets/[id]/route.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Waveform player shows error state when audio fails to load"
    - "Error message is user-friendly and actionable"
    - "Mock audio URLs use real sample files for testing"
  artifacts:
    - path: "src/components/asset/AudioWaveformPlayer.tsx"
      provides: "Audio waveform player with error handling"
      contains: "error event listener"
    - path: "src/app/api/assets/[id]/route.ts"
      provides: "Mock asset data with valid audio URLs"
      contains: "sample audio URL"
  key_links:
    - from: "src/components/asset/AudioWaveformPlayer.tsx"
      to: "wavesurfer"
      via: "error event listener"
      pattern: "wavesurfer\\.on\\('error'"
---

<objective>
Fix waveform player error handling and mock audio URLs

Purpose: UAT Test 9 (Audio/Video Preview) failed because waveforms show perpetual loading state when audio fails to load. The mock API returns invalid URLs (https://mock-s3.example.com) that 404, and the AudioWaveformPlayer component lacks error handling.

Output: Working waveform player that gracefully handles load failures with a user-friendly error message, and mock API that uses real sample audio URLs for testing.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-catalog-management/04-10-SUMMARY.md

Debug session with full diagnosis:
@.planning/debug/waveforms-unable-to-load.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add error handling to AudioWaveformPlayer</name>
  <files>src/components/asset/AudioWaveformPlayer.tsx</files>
  <action>
Add error state management and error event listener to AudioWaveformPlayer:

1. Add error state: `const [error, setError] = useState<string | null>(null)`

2. Add error event listener in the useEffect that registers play/pause/finish handlers:
```typescript
const handleError = (err: Error) => {
  console.error('WaveSurfer error:', err)
  setError('Unable to load audio. The file may be unavailable or in an unsupported format.')
}
wavesurfer.on('error', handleError)
```

3. Clean up error listener in the return function:
```typescript
wavesurfer.un('error', handleError)
```

4. Add error UI display - replace the loading indicator section with conditional rendering:
```typescript
{/* Status indicator */}
{!isReady && !error && (
  <div className="text-sm text-gray-500">Loading waveform...</div>
)}
{error && (
  <div className="text-sm text-red-600">{error}</div>
)}
```

5. Disable play button when error occurs - update disabled condition:
```typescript
disabled={!isReady || !!error}
```

6. Show error state in the waveform container area as well (when error, show an error icon and message instead of empty waveform):
```typescript
{error ? (
  <div className="rounded-lg bg-red-50 p-4 flex items-center gap-3">
    <ErrorIcon className="h-6 w-6 text-red-500 flex-shrink-0" />
    <div>
      <p className="text-sm font-medium text-red-800">Audio unavailable</p>
      <p className="text-sm text-red-600">{error}</p>
    </div>
  </div>
) : (
  <div
    ref={containerRef}
    className="rounded-lg bg-gray-50 p-4 cursor-pointer"
    onClick={onPlayPause}
  />
)}
```

7. Add ErrorIcon component:
```typescript
function ErrorIcon({ className }: { className?: string }) {
  return (
    <svg className={className} fill="none" viewBox="0 0 24 24" strokeWidth={1.5} stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" d="M12 9v3.75m9-.75a9 9 0 11-18 0 9 9 0 0118 0zm-9 3.75h.008v.008H12v-.008z" />
    </svg>
  )
}
```
  </action>
  <verify>TypeScript compiles without errors: `npx tsc --noEmit`</verify>
  <done>AudioWaveformPlayer shows error UI when audio fails to load instead of perpetual loading state</done>
</task>

<task type="auto">
  <name>Task 2: Update mock API to use valid sample audio URLs</name>
  <files>src/app/api/assets/[id]/route.ts</files>
  <action>
Update the mock asset generation to use publicly accessible sample audio files for music and SFX assets:

1. At the top of the file, add sample audio URL constants:
```typescript
// Use public domain sample audio for mock testing
// These are short, royalty-free audio clips from archive.org
const SAMPLE_AUDIO_URLS = {
  music: [
    'https://upload.wikimedia.org/wikipedia/commons/4/40/Toreador_song_cleaned.ogg',
    'https://upload.wikimedia.org/wikipedia/commons/c/c1/Beethoven_-_Bagatelle_in_A_minor_%22F%C3%BCr_Elise%22_WoO_59.ogg',
    'https://upload.wikimedia.org/wikipedia/commons/0/0e/Barcarolle_from_%22Tales_of_Hoffmann%22.ogg',
  ],
  sfx: [
    'https://upload.wikimedia.org/wikipedia/commons/3/3f/Fm-synth-bass-001.ogg',
    'https://upload.wikimedia.org/wikipedia/commons/6/6f/Cello_pizzicato_3.ogg',
  ],
}
```

2. In the music asset generation section (around line 44-45), replace the mock fileUrl:
```typescript
// Before:
fileUrl: `https://mock-s3.example.com/uploads/${id}/original.mp3`,

// After:
fileUrl: SAMPLE_AUDIO_URLS.music[assetNum % SAMPLE_AUDIO_URLS.music.length],
```

3. For SFX assets (around line 109-110), do the same:
```typescript
// In baseAsset for SFX, override the fileUrl in the SFX asset creation
fileUrl: SAMPLE_AUDIO_URLS.sfx[(assetNum - 300) % SAMPLE_AUDIO_URLS.sfx.length],
```

4. Keep the mock URLs for video/LUT assets as they were (motion-graphics, lut, stock-footage) since they use different file types and the video player has different requirements.

NOTE: The baseAsset template on line 44-45 sets fileUrl for all types. We need to override it specifically for music and sfx in their respective sections. For music assets, add `fileUrl` to the MusicAsset object. For SFX, add `fileUrl` to the SfxAsset object.
  </action>
  <verify>
1. Start dev server: `npm run dev`
2. Navigate to a music asset detail page (e.g., /assets/asset-1)
3. Waveform should load and play actual audio
  </verify>
  <done>Mock music and SFX assets return valid sample audio URLs that WaveSurfer can load</done>
</task>

</tasks>

<verification>
1. Navigate to /assets/music in the browser
2. Click on any music asset to open detail page
3. Verify waveform loads and displays actual audio waveform
4. Click waveform or play button to play audio
5. If audio fails to load (e.g., network issues), verify error message is shown instead of perpetual loading
</verification>

<success_criteria>
- Waveform player shows user-friendly error state when audio fails to load
- Mock music/SFX assets use valid sample audio URLs that load successfully
- Play/pause functionality works with real audio
- UAT Test 9 (Audio/Video Preview) can now pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-catalog-management/04-15-SUMMARY.md`
</output>
