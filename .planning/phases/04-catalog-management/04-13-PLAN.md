---
phase: 04-catalog-management
plan: 13
type: execute
wave: 6
depends_on: ["04-07", "04-09"]
files_modified:
  - src/app/(platform)/assets/[id]/components/ActivityTab.tsx
  - src/app/api/assets/[id]/activity/route.ts
  - src/lib/api/assets.ts
  - src/components/command-palette/SearchResults.tsx
  - src/hooks/useGlobalSearch.tsx
autonomous: true

must_haves:
  truths:
    - "Activity tab shows audit log for asset changes"
    - "Global search includes assets in results"
    - "Command palette can navigate to assets"
  artifacts:
    - path: "src/app/(platform)/assets/[id]/components/ActivityTab.tsx"
      provides: "Asset activity audit log"
      exports: ["ActivityTab"]
    - path: "src/app/api/assets/[id]/activity/route.ts"
      provides: "Asset activity endpoint"
      exports: ["GET"]
  key_links:
    - from: "src/hooks/useGlobalSearch.tsx"
      to: "src/app/api/search/route.ts"
      via: "includes asset results"
      pattern: "assets.*search"
---

<objective>
Complete the activity tab with audit logs and integrate assets into global search.

Purpose: Staff can see change history and find assets via command palette search.
Output: Activity tab with audit log and assets included in global search results.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-catalog-management/CONTEXT.md
@.planning/phases/04-catalog-management/04-07-SUMMARY.md
@.planning/phases/04-catalog-management/04-09-SUMMARY.md

# Existing search patterns
@src/app/api/search/route.ts
@src/hooks/useGlobalSearch.tsx
@src/components/command-palette/SearchResults.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create activity API and tab component</name>
  <files>src/app/api/assets/[id]/activity/route.ts, src/lib/api/assets.ts, src/app/(platform)/assets/[id]/components/ActivityTab.tsx</files>
  <action>
Create activity endpoint:

GET /api/assets/[id]/activity:
- Return array of audit log entries for this asset
- Mock entries include: asset created, metadata updated, status changed, platform changed
- Each entry: { id, action, actorId, actorName, details, createdAt }
- Generate 5-10 mock entries per asset
- Sorted by createdAt descending (newest first)

Add to src/lib/api/assets.ts:
```typescript
export async function getAssetActivity(assetId: string): Promise<ActivityEntry[]> {
  return apiClient(`/api/assets/${assetId}/activity`)
}
```

Replace ActivityTab placeholder:
```typescript
'use client'

import { useState, useEffect } from 'react'
import type { Asset } from '@/types/asset'
import { getAssetActivity } from '@/lib/api/assets'

interface ActivityEntry {
  id: string
  action: string
  actorId: string
  actorName: string
  details: string
  createdAt: string
}

interface ActivityTabProps {
  asset: Asset
}

export function ActivityTab({ asset }: ActivityTabProps) {
  const [activity, setActivity] = useState<ActivityEntry[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function loadActivity() {
      try {
        const data = await getAssetActivity(asset.id)
        setActivity(data)
      } catch (error) {
        console.error('Failed to load activity:', error)
      } finally {
        setLoading(false)
      }
    }
    loadActivity()
  }, [asset.id])

  if (loading) {
    return <div className="text-gray-500">Loading activity...</div>
  }

  if (activity.length === 0) {
    return (
      <div className="bg-gray-50 rounded-lg p-6 text-center">
        <p className="text-gray-600">No activity recorded for this asset.</p>
      </div>
    )
  }

  return (
    <div className="space-y-4">
      <h2 className="text-lg font-medium text-gray-900">Activity Log</h2>

      <div className="flow-root">
        <ul className="-mb-8">
          {activity.map((entry, index) => (
            <li key={entry.id}>
              <div className="relative pb-8">
                {index !== activity.length - 1 && (
                  <span
                    className="absolute left-4 top-4 -ml-px h-full w-0.5 bg-gray-200"
                    aria-hidden="true"
                  />
                )}
                <div className="relative flex space-x-3">
                  <div>
                    <span className="h-8 w-8 rounded-full bg-gray-100 flex items-center justify-center ring-8 ring-white">
                      <ActivityIcon action={entry.action} />
                    </span>
                  </div>
                  <div className="flex min-w-0 flex-1 justify-between space-x-4 pt-1.5">
                    <div>
                      <p className="text-sm text-gray-500">
                        <span className="font-medium text-gray-900">{entry.actorName}</span>
                        {' '}{entry.action.toLowerCase()}
                      </p>
                      {entry.details && (
                        <p className="mt-1 text-sm text-gray-600">{entry.details}</p>
                      )}
                    </div>
                    <div className="whitespace-nowrap text-right text-sm text-gray-500">
                      {formatRelativeTime(new Date(entry.createdAt))}
                    </div>
                  </div>
                </div>
              </div>
            </li>
          ))}
        </ul>
      </div>
    </div>
  )
}

function ActivityIcon({ action }: { action: string }) {
  const iconClass = 'h-4 w-4 text-gray-500'

  if (action.includes('create')) {
    return (
      <svg className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
      </svg>
    )
  }
  if (action.includes('update') || action.includes('edit')) {
    return (
      <svg className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    )
  }
  if (action.includes('approve') || action.includes('publish')) {
    return (
      <svg className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
      </svg>
    )
  }
  if (action.includes('reject')) {
    return (
      <svg className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
      </svg>
    )
  }

  return (
    <svg className={iconClass} fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  )
}

function formatRelativeTime(date: Date): string {
  const now = new Date()
  const diffMs = now.getTime() - date.getTime()
  const diffMins = Math.floor(diffMs / (1000 * 60))
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60))
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

  if (diffMins < 1) return 'Just now'
  if (diffMins < 60) return `${diffMins}m ago`
  if (diffHours < 24) return `${diffHours}h ago`
  if (diffDays < 7) return `${diffDays}d ago`
  return date.toLocaleDateString()
}
```
  </action>
  <verify>Activity tab shows timeline of asset changes</verify>
  <done>Activity tab displays audit log with action icons and relative timestamps</done>
</task>

<task type="auto">
  <name>Task 2: Integrate assets into global search</name>
  <files>src/app/api/search/route.ts, src/hooks/useGlobalSearch.tsx, src/components/command-palette/SearchResults.tsx</files>
  <action>
Update the global search API to include assets:

In src/app/api/search/route.ts:
- Add 'assets' to the entity types
- Generate mock asset search results (title, type, contributor matches)
- Return assets alongside users in the results

Example asset search result:
```typescript
{
  type: 'asset',
  id: 'asset-123',
  title: 'Summer Vibes',
  subtitle: 'Music by John Doe',
  url: '/assets/asset-123',
}
```

Update src/hooks/useGlobalSearch.tsx:
- Add 'asset' to the SearchResult type
- Ensure assets are included in Fuse.js search configuration

Update src/components/command-palette/SearchResults.tsx:
- Add asset icon/styling for asset type results
- Asset results show music note icon (or type-specific icon)
- Label shows asset type (Music, SFX, etc.)

Search should match:
- Asset title (weight: 2)
- Contributor name (weight: 1.5)
- Genre (weight: 1)
  </action>
  <verify>Searching in command palette returns asset results</verify>
  <done>Global search includes assets with type labels and navigation</done>
</task>

</tasks>

<verification>
1. Activity tab shows audit log entries
2. Activity entries have appropriate icons per action type
3. Relative time formatting works (just now, 5m ago, 2h ago)
4. Command palette search returns asset results
5. Clicking asset search result navigates to /assets/[id]
6. Asset results show type badge (Music, SFX, etc.)
</verification>

<success_criteria>
- Activity tab provides full audit trail
- Global search finds assets by title, contributor, genre
- Search results clearly indicate asset type
- Command palette navigation to assets works
</success_criteria>

<output>
After completion, create `.planning/phases/04-catalog-management/04-13-SUMMARY.md`
</output>
