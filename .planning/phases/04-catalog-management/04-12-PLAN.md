---
phase: 04-catalog-management
plan: 12
type: execute
wave: 5
depends_on: ["04-01", "04-09"]
files_modified:
  - src/app/api/collections/route.ts
  - src/app/api/collections/[id]/route.ts
  - src/app/api/collections/[id]/assets/route.ts
  - src/lib/api/collections.ts
  - src/app/(platform)/collections/page.tsx
  - src/app/(platform)/collections/loading.tsx
  - src/app/(platform)/collections/[id]/page.tsx
  - src/app/(platform)/assets/[id]/components/CollectionsTab.tsx
autonomous: true

must_haves:
  truths:
    - "Collections API supports CRUD and asset management"
    - "Collections list page shows all collections"
    - "Collection detail page shows assets in collection"
    - "Assets can be added/removed from collections"
  artifacts:
    - path: "src/app/api/collections/route.ts"
      provides: "Collection list and create endpoints"
      exports: ["GET", "POST"]
    - path: "src/app/(platform)/collections/page.tsx"
      provides: "Collections list page"
      exports: ["default"]
    - path: "src/app/(platform)/assets/[id]/components/CollectionsTab.tsx"
      provides: "Asset collections management"
      exports: ["CollectionsTab"]
  key_links:
    - from: "src/app/(platform)/collections/page.tsx"
      to: "src/lib/api/collections.ts"
      via: "getCollections fetch"
      pattern: "import.*getCollections"
---

<objective>
Build collections management for organizing assets into curated groups.

Purpose: Staff can create collections and organize assets for playlists, themes, and categories.
Output: Complete collections CRUD with asset management.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-catalog-management/CONTEXT.md
@.planning/phases/04-catalog-management/04-01-SUMMARY.md
@.planning/phases/04-catalog-management/04-09-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create collections API and client functions</name>
  <files>src/app/api/collections/route.ts, src/app/api/collections/[id]/route.ts, src/app/api/collections/[id]/assets/route.ts, src/lib/api/collections.ts, src/middleware.ts</files>
  <action>
Create collections API following the assets API pattern:

GET /api/collections:
- Query params: platform, query (search), page, limit
- Generate 30 mock collections with varied asset counts
- Return paginated response

POST /api/collections:
- Accept: { title, description?, platform, assetIds?: string[] }
- Create collection with empty assetIds if not provided
- Return created collection

GET /api/collections/[id]:
- Return full collection detail including asset list (simplified asset data)

PATCH /api/collections/[id]:
- Update title, description, platform
- Return updated collection

POST /api/collections/[id]/assets:
- Accept: { assetIds: string[] }
- Add assets to collection (append to existing)
- Return updated collection

DELETE /api/collections/[id]/assets/[assetId]:
- Remove single asset from collection
- Return updated collection

Create src/lib/api/collections.ts:
- getCollections(params)
- getCollection(id)
- createCollection(data)
- updateCollection(id, data)
- addAssetsToCollection(collectionId, assetIds)
- removeAssetFromCollection(collectionId, assetId)

Update middleware.ts to add /api/collections to public paths.
  </action>
  <verify>curl localhost:3000/api/collections returns paginated list</verify>
  <done>Collections API supports full CRUD and asset management</done>
</task>

<task type="auto">
  <name>Task 2: Create collections list and detail pages</name>
  <files>src/app/(platform)/collections/page.tsx, src/app/(platform)/collections/loading.tsx, src/app/(platform)/collections/[id]/page.tsx, src/components/layout/Sidebar.tsx</files>
  <action>
Create collections list page:
```typescript
// src/app/(platform)/collections/page.tsx
import { getCollections } from '@/lib/api/collections'
import { Button } from '@music-vine/cadence'
import Link from 'next/link'

export default async function CollectionsPage({
  searchParams,
}: {
  searchParams: Promise<{ platform?: string; query?: string; page?: string }>
}) {
  const { platform, query, page } = await searchParams
  const collections = await getCollections({
    platform: platform as any,
    query,
    page: page ? parseInt(page) : 1,
  })

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-2xl font-semibold text-gray-900">Collections</h1>
          <p className="mt-1 text-sm text-gray-600">
            Organize assets into curated collections
          </p>
        </div>
        <Button variant="bold">Create Collection</Button>
      </div>

      {/* Collection grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        {collections.data.map((collection) => (
          <Link
            key={collection.id}
            href={`/collections/${collection.id}`}
            className="block bg-white rounded-lg border border-gray-200 p-4 hover:border-gray-300 transition-colors"
          >
            <h3 className="font-medium text-gray-900">{collection.title}</h3>
            <div className="mt-2 flex items-center gap-2 text-sm text-gray-500">
              <span>{collection.assetCount} assets</span>
              <span>â€¢</span>
              <span>{collection.platform === 'both' ? 'All Platforms' : collection.platform}</span>
            </div>
          </Link>
        ))}
      </div>
    </div>
  )
}
```

Create collection detail page showing assets in the collection as a grid/list with remove buttons.

Add Collections to Sidebar.tsx navigation between Assets and Settings.

Create loading.tsx with card skeletons.
  </action>
  <verify>Collections page renders grid of collection cards</verify>
  <done>Collections pages display list and detail views</done>
</task>

<task type="auto">
  <name>Task 3: Update asset detail collections tab</name>
  <files>src/app/(platform)/assets/[id]/components/CollectionsTab.tsx</files>
  <action>
Replace CollectionsTab placeholder with functional component:

```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import Link from 'next/link'
import { Button } from '@music-vine/cadence'
import type { Asset } from '@/types/asset'
import type { CollectionListItem } from '@/types/collection'
import { getCollections, addAssetsToCollection, removeAssetFromCollection } from '@/lib/api/collections'
import { toast } from 'sonner'

interface CollectionsTabProps {
  asset: Asset
}

export function CollectionsTab({ asset }: CollectionsTabProps) {
  const router = useRouter()
  const [collections, setCollections] = useState<CollectionListItem[]>([])
  const [allCollections, setAllCollections] = useState<CollectionListItem[]>([])
  const [loading, setLoading] = useState(true)
  const [showAddModal, setShowAddModal] = useState(false)

  useEffect(() => {
    async function loadCollections() {
      try {
        // Get all collections to find which ones contain this asset
        const all = await getCollections({ limit: 100 })
        setAllCollections(all.data)

        // Filter to collections containing this asset
        // (In real implementation, this would be a separate API call)
        const containing = all.data.filter((c: any) =>
          c.assetIds?.includes(asset.id)
        )
        setCollections(containing)
      } catch (error) {
        console.error('Failed to load collections:', error)
      } finally {
        setLoading(false)
      }
    }
    loadCollections()
  }, [asset.id])

  const handleAddToCollection = async (collectionId: string) => {
    try {
      await addAssetsToCollection(collectionId, [asset.id])
      toast.success('Added to collection')
      router.refresh()
      setShowAddModal(false)
    } catch (error) {
      toast.error('Failed to add to collection')
    }
  }

  const handleRemoveFromCollection = async (collectionId: string) => {
    try {
      await removeAssetFromCollection(collectionId, asset.id)
      toast.success('Removed from collection')
      setCollections(prev => prev.filter(c => c.id !== collectionId))
    } catch (error) {
      toast.error('Failed to remove from collection')
    }
  }

  const availableCollections = allCollections.filter(
    c => !collections.find(existing => existing.id === c.id)
  )

  if (loading) {
    return <div className="text-gray-500">Loading collections...</div>
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-medium text-gray-900">
          In {collections.length} Collection{collections.length !== 1 ? 's' : ''}
        </h2>
        <Button variant="subtle" onClick={() => setShowAddModal(true)}>
          Add to Collection
        </Button>
      </div>

      {/* Collections list */}
      {collections.length === 0 ? (
        <div className="bg-gray-50 rounded-lg p-6 text-center">
          <p className="text-gray-600">This asset is not in any collections.</p>
          <Button
            variant="bold"
            className="mt-4"
            onClick={() => setShowAddModal(true)}
          >
            Add to Collection
          </Button>
        </div>
      ) : (
        <ul className="divide-y divide-gray-200 border border-gray-200 rounded-lg">
          {collections.map((collection) => (
            <li key={collection.id} className="flex items-center justify-between p-4">
              <Link
                href={`/collections/${collection.id}`}
                className="font-medium text-gray-900 hover:text-platform-primary"
              >
                {collection.title}
              </Link>
              <button
                onClick={() => handleRemoveFromCollection(collection.id)}
                className="text-sm text-red-600 hover:text-red-800"
              >
                Remove
              </button>
            </li>
          ))}
        </ul>
      )}

      {/* Add to collection modal */}
      {showAddModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50">
          <div className="bg-white rounded-lg p-6 w-full max-w-md">
            <h3 className="text-lg font-medium text-gray-900 mb-4">
              Add to Collection
            </h3>

            {availableCollections.length === 0 ? (
              <p className="text-gray-600">No available collections.</p>
            ) : (
              <ul className="divide-y divide-gray-200 max-h-64 overflow-auto">
                {availableCollections.map((collection) => (
                  <li key={collection.id}>
                    <button
                      onClick={() => handleAddToCollection(collection.id)}
                      className="w-full text-left px-4 py-3 hover:bg-gray-50"
                    >
                      {collection.title}
                    </button>
                  </li>
                ))}
              </ul>
            )}

            <div className="mt-4 flex justify-end">
              <Button variant="subtle" onClick={() => setShowAddModal(false)}>
                Cancel
              </Button>
            </div>
          </div>
        </div>
      )}
    </div>
  )
}
```
  </action>
  <verify>Collections tab shows which collections contain the asset with add/remove options</verify>
  <done>Asset collections tab enables adding to and removing from collections</done>
</task>

</tasks>

<verification>
1. Collections API returns paginated list
2. Collections page shows grid of collection cards
3. Collection detail page shows assets
4. Asset collections tab shows containing collections
5. Add to collection modal lists available collections
6. Remove from collection works with toast feedback
</verification>

<success_criteria>
- Collections support CRUD operations
- Assets can belong to multiple collections
- Collections tab on asset detail shows membership
- Navigation between collections and assets works
</success_criteria>

<output>
After completion, create `.planning/phases/04-catalog-management/04-12-SUMMARY.md`
</output>
