---
phase: 04-catalog-management
plan: 11
type: execute
wave: 5
depends_on: ["04-01", "04-03", "04-09"]
files_modified:
  - src/components/workflow/WorkflowTimeline.tsx
  - src/components/workflow/ApprovalForm.tsx
  - src/components/workflow/index.ts
  - src/app/(platform)/assets/[id]/components/WorkflowTab.tsx
autonomous: true

must_haves:
  truths:
    - "Workflow timeline shows approval stages with visual indicators"
    - "Current stage highlighted, future stages grayed"
    - "Approval form shows checklist and comment fields"
    - "Actions are disabled when user is not the reviewer"
  artifacts:
    - path: "src/components/workflow/WorkflowTimeline.tsx"
      provides: "Visual workflow progress indicator"
      exports: ["WorkflowTimeline"]
    - path: "src/components/workflow/ApprovalForm.tsx"
      provides: "Checklist and action form"
      exports: ["ApprovalForm"]
    - path: "src/app/(platform)/assets/[id]/components/WorkflowTab.tsx"
      provides: "Complete workflow management tab"
      exports: ["WorkflowTab"]
  key_links:
    - from: "src/components/workflow/ApprovalForm.tsx"
      to: "src/lib/workflow/transitions.ts"
      via: "getAvailableActions"
      pattern: "import.*getAvailableActions"
---

<objective>
Build the workflow tab with approval timeline and action forms for asset review.

Purpose: Staff can see approval history and take workflow actions (approve, reject, request changes).
Output: Complete workflow tab with timeline visualization and approval controls.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-catalog-management/CONTEXT.md
@.planning/phases/04-catalog-management/04-RESEARCH.md
@.planning/phases/04-catalog-management/04-01-SUMMARY.md
@.planning/phases/04-catalog-management/04-03-SUMMARY.md
@.planning/phases/04-catalog-management/04-09-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create workflow timeline component</name>
  <files>src/components/workflow/WorkflowTimeline.tsx</files>
  <action>
Create timeline component following RESEARCH Pattern 5:

```typescript
'use client'

import type { WorkflowHistoryItem, MusicWorkflowState, SimpleWorkflowState } from '@/types/workflow'
import { getStateLabel, MUSIC_WORKFLOW_STATES, SIMPLE_WORKFLOW_STATES, isRejectedState } from '@/lib/workflow/states'

interface TimelineStage {
  state: string
  label: string
  status: 'completed' | 'current' | 'pending' | 'rejected'
  historyItem?: WorkflowHistoryItem
}

interface WorkflowTimelineProps {
  currentState: string
  isMusic: boolean
  history: WorkflowHistoryItem[]
}

export function WorkflowTimeline({ currentState, isMusic, history }: WorkflowTimelineProps) {
  const stages = isMusic ? MUSIC_WORKFLOW_STATES : SIMPLE_WORKFLOW_STATES

  // Build timeline stages with status
  const timelineStages: TimelineStage[] = stages.map((state) => {
    const historyItem = history.find(h => h.toState === state)
    const currentIndex = stages.indexOf(currentState as any)
    const stageIndex = stages.indexOf(state as any)

    let status: TimelineStage['status'] = 'pending'
    if (isRejectedState(currentState)) {
      // Show rejection path
      if (historyItem) {
        status = 'completed'
      }
      if (state === currentState) {
        status = 'rejected'
      }
    } else if (stageIndex < currentIndex) {
      status = 'completed'
    } else if (stageIndex === currentIndex) {
      status = 'current'
    }

    return {
      state,
      label: getStateLabel(state),
      status,
      historyItem,
    }
  })

  return (
    <ol className="relative border-l-2 border-gray-200 ml-4">
      {timelineStages.map((stage, index) => (
        <li key={stage.state} className="mb-8 ml-6 last:mb-0">
          {/* Status indicator */}
          <span className={`
            absolute -left-3 flex h-6 w-6 items-center justify-center rounded-full ring-4 ring-white
            ${stage.status === 'completed' ? 'bg-green-500' : ''}
            ${stage.status === 'current' ? 'bg-blue-500' : ''}
            ${stage.status === 'pending' ? 'bg-gray-300' : ''}
            ${stage.status === 'rejected' ? 'bg-red-500' : ''}
          `}>
            {stage.status === 'completed' && <CheckIcon className="h-4 w-4 text-white" />}
            {stage.status === 'current' && <span className="h-2 w-2 rounded-full bg-white" />}
            {stage.status === 'rejected' && <XIcon className="h-4 w-4 text-white" />}
          </span>

          {/* Content */}
          <div>
            <h3 className={`font-medium ${
              stage.status === 'current' ? 'text-blue-900' :
              stage.status === 'rejected' ? 'text-red-900' :
              stage.status === 'completed' ? 'text-gray-900' :
              'text-gray-500'
            }`}>
              {stage.label}
            </h3>

            {stage.historyItem && (
              <div className="mt-1 text-sm text-gray-600">
                <span>{stage.historyItem.reviewerName}</span>
                <span className="mx-2">â€¢</span>
                <span>{formatRelativeTime(new Date(stage.historyItem.createdAt))}</span>
              </div>
            )}

            {/* Feedback/comments */}
            {stage.historyItem?.comments && (
              <p className="mt-2 text-sm text-gray-700 bg-gray-50 p-3 rounded-lg">
                {stage.historyItem.comments}
              </p>
            )}

            {/* Checklist */}
            {stage.historyItem?.checklist && stage.historyItem.checklist.length > 0 && (
              <ul className="mt-2 space-y-1">
                {stage.historyItem.checklist.map((item, i) => (
                  <li key={i} className="flex items-center gap-2 text-sm">
                    {item.checked ? (
                      <CheckCircleIcon className="h-4 w-4 text-green-500 flex-shrink-0" />
                    ) : (
                      <XCircleIcon className="h-4 w-4 text-red-500 flex-shrink-0" />
                    )}
                    <span className={item.checked ? 'text-gray-700' : 'text-red-700'}>
                      {item.item}
                    </span>
                  </li>
                ))}
              </ul>
            )}
          </div>
        </li>
      ))}
    </ol>
  )
}

function formatRelativeTime(date: Date): string {
  const now = new Date()
  const diffMs = now.getTime() - date.getTime()
  const diffMins = Math.floor(diffMs / (1000 * 60))
  const diffHours = Math.floor(diffMs / (1000 * 60 * 60))
  const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

  if (diffMins < 1) return 'Just now'
  if (diffMins < 60) return `${diffMins} min ago`
  if (diffHours < 24) return `${diffHours} hours ago`
  if (diffDays < 7) return `${diffDays} days ago`
  return date.toLocaleDateString()
}

function CheckIcon({ className }: { className?: string }) {
  return (
    <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
    </svg>
  )
}

function XIcon({ className }: { className?: string }) {
  return (
    <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={3}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M6 18L18 6M6 6l12 12" />
    </svg>
  )
}

function CheckCircleIcon({ className }: { className?: string }) {
  return (
    <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  )
}

function XCircleIcon({ className }: { className?: string }) {
  return (
    <svg className={className} fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
      <path strokeLinecap="round" strokeLinejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
    </svg>
  )
}
```
  </action>
  <verify>Timeline renders with correct stage indicators and colors</verify>
  <done>Workflow timeline shows completed, current, and pending stages with history details</done>
</task>

<task type="auto">
  <name>Task 2: Create approval form component</name>
  <files>src/components/workflow/ApprovalForm.tsx</files>
  <action>
Create approval form with checklist and actions:

```typescript
'use client'

import { useState } from 'react'
import { Button } from '@music-vine/cadence'
import type { Asset } from '@/types/asset'
import type { WorkflowActionType, ChecklistItem } from '@/types/workflow'
import { getAvailableActions, musicTransitions, simpleTransitions } from '@/lib/workflow/transitions'
import { isMusicAsset } from '@/types/asset'
import { approveAsset, rejectAsset } from '@/lib/api/assets'

interface ApprovalFormProps {
  asset: Asset
  onActionComplete: () => void
}

const CHECKLIST_ITEMS: Record<string, string[]> = {
  initial_review: [
    'Audio quality is acceptable',
    'File format is correct',
    'No copyright issues detected',
  ],
  quality_check: [
    'Metadata is accurate',
    'Tags are appropriate',
    'BPM/Key information is correct',
  ],
  platform_assignment: [
    'Platform selection confirmed',
  ],
  final_approval: [
    'All previous checks verified',
    'Ready for publication',
  ],
  review: [
    'Content quality acceptable',
    'Metadata complete',
    'No issues detected',
  ],
}

export function ApprovalForm({ asset, onActionComplete }: ApprovalFormProps) {
  const [checklist, setChecklist] = useState<ChecklistItem[]>(() => {
    const items = CHECKLIST_ITEMS[asset.status] || []
    return items.map(item => ({ item, checked: false }))
  })
  const [comments, setComments] = useState('')
  const [platform, setPlatform] = useState<'music-vine' | 'uppbeat' | 'both'>('both')
  const [isSubmitting, setIsSubmitting] = useState(false)

  const transitions = isMusicAsset(asset) ? musicTransitions : simpleTransitions
  const availableActions = getAvailableActions(asset.status, transitions)

  const canApprove = availableActions.includes('approve')
  const canReject = availableActions.includes('reject')
  const isPlatformAssignment = asset.status === 'platform_assignment'

  const handleApprove = async () => {
    setIsSubmitting(true)
    try {
      await approveAsset(asset.id, {
        checklist,
        comments: comments || undefined,
        ...(isPlatformAssignment ? { platform } : {}),
      })
      onActionComplete()
    } catch (error) {
      console.error('Approve failed:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  const handleReject = async () => {
    if (!comments.trim()) {
      alert('Please provide feedback for rejection')
      return
    }
    setIsSubmitting(true)
    try {
      await rejectAsset(asset.id, { checklist, comments })
      onActionComplete()
    } catch (error) {
      console.error('Reject failed:', error)
    } finally {
      setIsSubmitting(false)
    }
  }

  const toggleChecklistItem = (index: number) => {
    setChecklist(prev =>
      prev.map((item, i) =>
        i === index ? { ...item, checked: !item.checked } : item
      )
    )
  }

  // Show message if not in a reviewable state
  if (!canApprove && !canReject) {
    if (asset.status === 'draft') {
      return (
        <div className="bg-gray-50 rounded-lg p-6 text-center">
          <p className="text-gray-600">This asset has not been submitted for review yet.</p>
        </div>
      )
    }
    if (asset.status === 'published') {
      return (
        <div className="bg-green-50 rounded-lg p-6 text-center">
          <p className="text-green-700">This asset has been published.</p>
        </div>
      )
    }
    return (
      <div className="bg-yellow-50 rounded-lg p-6 text-center">
        <p className="text-yellow-700">No actions available for current state: {asset.status}</p>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Checklist */}
      {checklist.length > 0 && (
        <div>
          <h3 className="text-sm font-medium text-gray-900 mb-3">Review Checklist</h3>
          <div className="space-y-2">
            {checklist.map((item, index) => (
              <label key={index} className="flex items-center gap-3 cursor-pointer">
                <input
                  type="checkbox"
                  checked={item.checked}
                  onChange={() => toggleChecklistItem(index)}
                  className="h-4 w-4 rounded border-gray-300 text-platform-primary focus:ring-platform-primary"
                />
                <span className="text-sm text-gray-700">{item.item}</span>
              </label>
            ))}
          </div>
        </div>
      )}

      {/* Platform selection for platform_assignment stage */}
      {isPlatformAssignment && isMusicAsset(asset) && (
        <div>
          <h3 className="text-sm font-medium text-gray-900 mb-3">Platform Assignment</h3>
          <div className="flex gap-4">
            {(['music-vine', 'uppbeat', 'both'] as const).map((p) => (
              <label key={p} className="flex items-center gap-2 cursor-pointer">
                <input
                  type="radio"
                  name="platform"
                  value={p}
                  checked={platform === p}
                  onChange={() => setPlatform(p)}
                  className="h-4 w-4 border-gray-300 text-platform-primary focus:ring-platform-primary"
                />
                <span className="text-sm text-gray-700">
                  {p === 'music-vine' ? 'Music Vine Only' :
                   p === 'uppbeat' ? 'Uppbeat Only' :
                   'Both Platforms'}
                </span>
              </label>
            ))}
          </div>
        </div>
      )}

      {/* Comments */}
      <div>
        <label className="block text-sm font-medium text-gray-900 mb-2">
          Comments {canReject && <span className="text-gray-500">(required for rejection)</span>}
        </label>
        <textarea
          value={comments}
          onChange={(e) => setComments(e.target.value)}
          rows={3}
          className="w-full rounded-lg border border-gray-300 px-3 py-2 text-sm focus:border-platform-primary focus:ring-1 focus:ring-platform-primary"
          placeholder="Add feedback or notes..."
        />
      </div>

      {/* Actions */}
      <div className="flex gap-3">
        {canApprove && (
          <Button
            variant="bold"
            onClick={handleApprove}
            disabled={isSubmitting}
          >
            {isSubmitting ? 'Processing...' : 'Approve'}
          </Button>
        )}
        {canReject && (
          <Button
            variant="error"
            onClick={handleReject}
            disabled={isSubmitting || !comments.trim()}
          >
            {isSubmitting ? 'Processing...' : 'Reject'}
          </Button>
        )}
      </div>
    </div>
  )
}
```
  </action>
  <verify>Approval form shows correct checklist items per workflow stage</verify>
  <done>Approval form handles approve/reject with checklist and platform assignment</done>
</task>

<task type="auto">
  <name>Task 3: Build complete workflow tab</name>
  <files>src/components/workflow/index.ts, src/app/(platform)/assets/[id]/components/WorkflowTab.tsx</files>
  <action>
Create index.ts:
```typescript
export * from './WorkflowTimeline'
export * from './ApprovalForm'
```

Update WorkflowTab.tsx to replace placeholder:
```typescript
'use client'

import { useState, useEffect } from 'react'
import { useRouter } from 'next/navigation'
import type { Asset } from '@/types/asset'
import type { WorkflowHistoryItem } from '@/types/workflow'
import { isMusicAsset } from '@/types/asset'
import { getWorkflowHistory } from '@/lib/api/assets'
import { WorkflowTimeline, ApprovalForm } from '@/components/workflow'

interface WorkflowTabProps {
  asset: Asset
}

export function WorkflowTab({ asset }: WorkflowTabProps) {
  const router = useRouter()
  const [history, setHistory] = useState<WorkflowHistoryItem[]>([])
  const [loading, setLoading] = useState(true)

  useEffect(() => {
    async function loadHistory() {
      try {
        const data = await getWorkflowHistory(asset.id)
        setHistory(data)
      } catch (error) {
        console.error('Failed to load workflow history:', error)
      } finally {
        setLoading(false)
      }
    }
    loadHistory()
  }, [asset.id])

  const handleActionComplete = () => {
    // Refresh the page to show updated state
    router.refresh()
  }

  return (
    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
      {/* Timeline */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h2 className="text-lg font-medium text-gray-900 mb-6">Approval Progress</h2>
        {loading ? (
          <div className="text-gray-500">Loading history...</div>
        ) : (
          <WorkflowTimeline
            currentState={asset.status}
            isMusic={isMusicAsset(asset)}
            history={history}
          />
        )}
      </div>

      {/* Actions */}
      <div className="bg-white rounded-lg border border-gray-200 p-6">
        <h2 className="text-lg font-medium text-gray-900 mb-6">Review Actions</h2>
        <ApprovalForm asset={asset} onActionComplete={handleActionComplete} />
      </div>
    </div>
  )
}
```
  </action>
  <verify>Workflow tab shows timeline and approval form side-by-side</verify>
  <done>Complete workflow tab with timeline visualization and action controls</done>
</task>

</tasks>

<verification>
1. Timeline shows all workflow stages with correct status
2. Completed stages have green checkmark
3. Current stage has blue indicator
4. Rejected state has red X indicator
5. Checklist items match current workflow stage
6. Platform assignment appears only for music in platform_assignment state
7. Reject requires comments
8. Action buttons disabled while submitting
</verification>

<success_criteria>
- Music assets show full multi-stage workflow timeline
- Non-music assets show simplified workflow timeline
- Approval form adapts checklist to current stage
- Platform assignment enforced for music before final approval
- Actions refresh the page to show updated state
</success_criteria>

<output>
After completion, create `.planning/phases/04-catalog-management/04-11-SUMMARY.md`
</output>
