---
phase: 02-user-management
plan: 07
type: execute
wave: 3
depends_on: ["02-05"]
files_modified:
  - src/app/(platform)/users/[id]/components/SubscriptionTab.tsx
  - src/app/(platform)/users/[id]/components/RefundDialog.tsx
  - src/app/api/users/[id]/refund/route.ts
autonomous: true

must_haves:
  truths:
    - "Subscription tab shows current plan details"
    - "Billing history displayed if available"
    - "Refund button opens confirmation dialog"
    - "Refund triggers backend endpoint"
  artifacts:
    - path: "src/app/(platform)/users/[id]/components/SubscriptionTab.tsx"
      provides: "Subscription tab content"
      exports: ["SubscriptionTab"]
    - path: "src/app/(platform)/users/[id]/components/RefundDialog.tsx"
      provides: "Refund confirmation dialog"
      exports: ["RefundDialog"]
    - path: "src/app/api/users/[id]/refund/route.ts"
      provides: "POST endpoint for refunds"
      exports: ["POST"]
  key_links:
    - from: "src/app/(platform)/users/[id]/components/RefundDialog.tsx"
      to: "/api/users/[id]/refund"
      via: "mutation"
      pattern: "refund"
---

<objective>
Create the Subscription tab with plan details, billing history, and refund functionality.

Purpose: Per CONTEXT.md, Subscription tab shows current plan details, billing history, subscription timeline, and entitlements. Refunds trigger backend endpoint (not frontend Stripe).

Output: Subscription tab with refund capability.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-RESEARCH.md

@src/types/user.ts
@src/app/(platform)/users/[id]/components/UserDetailTabs.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SubscriptionTab component</name>
  <files>src/app/(platform)/users/[id]/components/SubscriptionTab.tsx</files>
  <action>
Create client component for Subscription tab content:

1. 'use client' directive
2. Props: { user: UserDetail }

3. Current Plan section:
   - Subscription tier with badge (Free/Creator/Pro/Enterprise)
   - Plan started: {subscription.startedAt} formatted
   - Plan expires/renews: {subscription.expiresAt} formatted
   - Billing email: {subscription.billingEmail}
   - Status indicator (Active, Expired, Cancelled)

4. Entitlements section (based on tier):
   - Free: Limited downloads, watermarked
   - Creator: X downloads/month
   - Pro: Unlimited downloads
   - Enterprise: Team features
   - Display as checklist with checkmarks

5. Billing History section:
   - Mock billing history (3-5 entries):
     - Date, Amount, Status (Paid/Refunded/Failed), Invoice link
   - If no history: "No billing history"
   - Simple table or list format

6. Actions section:
   - RefundDialog component (triggers refund)
   - Place "Issue Refund" button here
   - Only show if user has paid history (tier !== 'free')

Per CONTEXT.md: "Contextual placement per section (Refund in Subscription)"
  </action>
  <verify>Click Subscription tab - plan details, entitlements, and billing history display</verify>
  <done>Subscription tab shows comprehensive plan information</done>
</task>

<task type="auto">
  <name>Task 2: Create RefundDialog component</name>
  <files>src/app/(platform)/users/[id]/components/RefundDialog.tsx</files>
  <action>
Create refund dialog with AlertDialog:

1. 'use client' directive
2. Import * as AlertDialog from '@radix-ui/react-alert-dialog'
3. Import { toast } from 'sonner'
4. Import { useMutation, useQueryClient } from '@tanstack/react-query'

5. Props: { userId: string, disabled?: boolean }

6. Refund mutation:
   - mutationFn: POST /api/users/{userId}/refund
   - onSuccess: toast.success('Refund initiated'), invalidate queries
   - onError: toast.error('Failed to process refund')

7. Dialog structure:
   - Trigger: "Issue Refund" button (Cadence Button, variant outline or secondary)
   - Title: "Issue Refund?"
   - Description: "This will initiate a refund for the user's most recent payment. The backend will process this through Stripe."
   - Note: "Note: Refunds may take 5-10 business days to appear on the user's statement."
   - Cancel button
   - "Process Refund" button (loading state during mutation)

Per CONTEXT.md: "Simple confirmation dialog (not reason-required modals)"
Per CONTEXT.md: "Refunds trigger backend endpoint that handles Stripe payment processing"
  </action>
  <verify>Click "Issue Refund" - dialog appears, confirm - toast shows success</verify>
  <done>Refund dialog with backend integration</done>
</task>

<task type="auto">
  <name>Task 3: Create refund API endpoint</name>
  <files>src/app/api/users/[id]/refund/route.ts</files>
  <action>
Create POST endpoint for refunds:

1. Extract userId from params (await params)
2. Mock implementation:
   - Log audit action (USER_REFUND_ISSUED)
   - In production: this calls backend .NET API which handles Stripe
   - Return { success: true, message: 'Refund initiated', refundId: 'ref_xxx' }
3. Add artificial 500ms delay to simulate Stripe processing time

Return 404 if user not found.
Return 400 if user has no refundable payments (mock: tier === 'free').

Add TODO comment: "Replace with backend API call for Stripe refund processing"
  </action>
  <verify>`curl -X POST http://localhost:3000/api/users/user-1/refund` returns success with refundId</verify>
  <done>Refund endpoint functional (mock)</done>
</task>

</tasks>

<verification>
1. Navigate to /users/user-1?tab=subscription
2. Current plan section shows tier, dates, billing email
3. Entitlements checklist displays tier-appropriate features
4. Billing history shows mock payment records
5. "Issue Refund" button visible (if not free tier)
6. Click "Issue Refund" - dialog appears
7. Confirm refund - toast shows "Refund initiated"
8. Free tier users don't see refund button
</verification>

<success_criteria>
- Subscription tab displays plan details
- Entitlements match subscription tier
- Billing history shows payment records
- Refund dialog with confirmation
- Successful refund shows toast
- Free tier users cannot issue refunds
- API endpoint returns mock refund response
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-07-SUMMARY.md`
</output>
