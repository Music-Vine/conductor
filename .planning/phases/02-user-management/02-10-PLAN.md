---
phase: 02-user-management
plan: 10
type: execute
wave: 4
depends_on: ["02-04"]
files_modified:
  - src/lib/utils/export-csv.ts
  - src/app/(platform)/users/components/ExportUsersButton.tsx
  - src/app/(platform)/users/components/UserFilters.tsx
autonomous: true

must_haves:
  truths:
    - "Staff can export current page of users to CSV"
    - "CSV includes all relevant user fields"
    - "Export button visible in user list"
    - "Download triggers immediately"
  artifacts:
    - path: "src/lib/utils/export-csv.ts"
      provides: "CSV export utility"
      exports: ["exportToCSV"]
    - path: "src/app/(platform)/users/components/ExportUsersButton.tsx"
      provides: "Export button component"
      exports: ["ExportUsersButton"]
  key_links:
    - from: "src/app/(platform)/users/components/ExportUsersButton.tsx"
      to: "src/lib/utils/export-csv.ts"
      via: "exportToCSV function"
      pattern: "exportToCSV"
    - from: "src/lib/utils/export-csv.ts"
      to: "react-papaparse"
      via: "jsonToCSV"
      pattern: "jsonToCSV.*papaparse"
---

<objective>
Implement CSV export functionality for user data.

Purpose: USER-08 requirement - staff can export user data to CSV. Per research, use react-papaparse for client-side export of current page/filtered results.

Output: Export button that downloads CSV of current user list.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-user-management/02-CONTEXT.md
@.planning/phases/02-user-management/02-RESEARCH.md

@src/types/user.ts
@src/app/(platform)/users/page.tsx
@src/app/(platform)/users/components/UserFilters.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create CSV export utility</name>
  <files>src/lib/utils/export-csv.ts</files>
  <action>
Create reusable CSV export utility:

1. Import { jsonToCSV } from 'react-papaparse'

2. Generic exportToCSV function:
   - Parameters:
     - data: T[] (array of objects)
     - filename: string
     - columns?: { key: keyof T, header: string }[] (optional column mapping)
   - If columns provided, transform data to use headers
   - Generate CSV with jsonToCSV
   - Trigger browser download

3. Download implementation:
   - Create Blob with text/csv MIME type
   - Create object URL
   - Create temporary anchor element
   - Set href and download attributes
   - Programmatically click
   - Clean up (remove element, revoke URL)

4. Export specific helper for users:
   - exportUsersToCSV(users: UserListItem[])
   - Column mapping:
     - id -> "User ID"
     - email -> "Email"
     - name -> "Name"
     - username -> "Username"
     - platform -> "Platform"
     - status -> "Status"
     - subscriptionTier -> "Subscription"
     - lastLoginAt -> "Last Login"
     - createdAt -> "Created"
   - Filename: users-{timestamp}.csv

Handle null values (convert to empty string).
  </action>
  <verify>Import exportUsersToCSV, call with mock data - CSV file downloads</verify>
  <done>CSV export utility ready for use</done>
</task>

<task type="auto">
  <name>Task 2: Create ExportUsersButton component</name>
  <files>src/app/(platform)/users/components/ExportUsersButton.tsx</files>
  <action>
Create export button component:

1. 'use client' directive
2. Import { toast } from 'sonner'
3. Import { exportUsersToCSV } from '@/lib/utils/export-csv'
4. Import Cadence Button component

5. Props:
   - users: UserListItem[]
   - disabled?: boolean

6. Handle export:
   - onClick calls exportUsersToCSV(users)
   - Show toast.success('Exported {count} users to CSV')
   - Handle errors with toast.error

7. Button styling:
   - Use Cadence Button with variant="outline" or similar
   - Icon: download arrow (inline SVG or Cadence icon)
   - Text: "Export CSV" or just icon with tooltip
   - Disabled state when no users or loading

Per research: "Export current page/filtered results (max 1000 records) - client-side with react-papaparse"
  </action>
  <verify>Click Export CSV button - file downloads with correct data</verify>
  <done>Export button triggers CSV download</done>
</task>

<task type="auto">
  <name>Task 3: Add export button to users page</name>
  <files>src/app/(platform)/users/components/UserFilters.tsx, src/app/(platform)/users/page.tsx</files>
  <action>
Integrate export button into users page:

1. Update UserFilters to accept users prop and include ExportUsersButton:
   - Add users: UserListItem[] to props
   - Render ExportUsersButton next to filters
   - Position: right side of filter bar, or below filters

2. Update users/page.tsx to pass users to UserFilters:
   - Pass fetched users to UserFilters component
   - Ensure users available before render

Alternative approach if UserFilters shouldn't have data:
- Add ExportUsersButton directly to page.tsx
- Position between filters and table

Layout consideration:
- Export button should be visible but not dominant
- Group with filters (above table)
- Show count: "Export {count} users"

Add barrel export for ExportUsersButton in components/index.ts.
  </action>
  <verify>Users page shows Export button, clicking exports current page to CSV</verify>
  <done>Export functionality integrated into user list</done>
</task>

</tasks>

<verification>
1. Navigate to /users
2. Export button visible in filter area
3. Click Export - CSV file downloads
4. Open CSV - columns match expected headers
5. Data matches current page of users
6. Apply filter, export again - exports filtered results
7. Empty results - button disabled or shows "No data to export"
8. Toast confirmation after export
</verification>

<success_criteria>
- Export button visible on users page
- Click triggers immediate CSV download
- CSV has proper headers and data
- Filename includes timestamp
- Handles empty data gracefully
- Toast confirms successful export
- Works with filtered results
</success_criteria>

<output>
After completion, create `.planning/phases/02-user-management/02-10-SUMMARY.md`
</output>
