---
phase: 03-advanced-table-features
plan: 05
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - src/hooks/useVirtualizedTable.tsx
autonomous: true

must_haves:
  truths:
    - "Hook integrates TanStack Table with TanStack Virtual"
    - "Scroll position resets to top on filter/sort changes"
    - "Scroll position preserves on data refresh"
    - "Fixed row height is used for virtualization"
  artifacts:
    - path: "src/hooks/useVirtualizedTable.tsx"
      provides: "Hook for virtualized table rendering"
      exports: ["useVirtualizedTable"]
      min_lines: 60
  key_links:
    - from: "src/hooks/useVirtualizedTable.tsx"
      to: "@tanstack/react-virtual"
      via: "useVirtualizer hook"
      pattern: "useVirtualizer"
    - from: "src/hooks/useVirtualizedTable.tsx"
      to: "@tanstack/react-table"
      via: "Table type integration"
      pattern: "Table"
---

<objective>
Create useVirtualizedTable hook that integrates TanStack Table with TanStack Virtual for smooth rendering of large datasets.

Purpose: Enable 60FPS scrolling for tables with 10k+ rows. The hook encapsulates virtualization logic so table components can focus on presentation.
Output: Reusable hook that provides virtual rows, scroll element ref, and smart scroll behavior.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-table-features/03-CONTEXT.md
@.planning/phases/03-advanced-table-features/03-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useVirtualizedTable hook</name>
  <files>src/hooks/useVirtualizedTable.tsx</files>
  <action>
Create `src/hooks/useVirtualizedTable.tsx`:

```typescript
'use client'

import { useRef, useEffect, useMemo } from 'react'
import { useVirtualizer, type VirtualItem } from '@tanstack/react-virtual'
import type { Table, Row } from '@tanstack/react-table'

interface UseVirtualizedTableOptions<T> {
  table: Table<T>
  rowHeight?: number
  overscan?: number
  containerHeight?: number
}

interface UseVirtualizedTableReturn<T> {
  parentRef: React.RefObject<HTMLDivElement>
  virtualRows: VirtualItem[]
  totalHeight: number
  rows: Row<T>[]
  scrollToTop: () => void
  scrollToIndex: (index: number) => void
}

// Default row height - fixed per CONTEXT decision for simpler/faster rendering
const DEFAULT_ROW_HEIGHT = 52

export function useVirtualizedTable<T>({
  table,
  rowHeight = DEFAULT_ROW_HEIGHT,
  overscan = 10,
  containerHeight = 600,
}: UseVirtualizedTableOptions<T>): UseVirtualizedTableReturn<T> {
  const parentRef = useRef<HTMLDivElement>(null)

  // Get rows from table
  const { rows } = table.getRowModel()

  // Create virtualizer
  const rowVirtualizer = useVirtualizer({
    count: rows.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => rowHeight,
    overscan,
  })

  const virtualRows = rowVirtualizer.getVirtualItems()
  const totalHeight = rowVirtualizer.getTotalSize()

  // Scroll utilities
  const scrollToTop = () => {
    rowVirtualizer.scrollToIndex(0, { align: 'start' })
  }

  const scrollToIndex = (index: number) => {
    rowVirtualizer.scrollToIndex(index, { align: 'center' })
  }

  return {
    parentRef,
    virtualRows,
    totalHeight,
    rows,
    scrollToTop,
    scrollToIndex,
  }
}

// Hook to manage scroll position based on filter/sort state
export function useSmartScrollReset<T>(
  virtualizedTable: UseVirtualizedTableReturn<T>,
  dependencies: unknown[] // Array of filter/sort state values
) {
  const { scrollToTop, parentRef } = virtualizedTable
  const previousScrollTop = useRef(0)
  const isFirstRender = useRef(true)

  // Reset scroll to top when filters/sorts change
  useEffect(() => {
    if (isFirstRender.current) {
      isFirstRender.current = false
      return
    }
    scrollToTop()
  }, dependencies) // eslint-disable-line react-hooks/exhaustive-deps

  // Save scroll position before data changes (for refresh preservation)
  useEffect(() => {
    const element = parentRef.current
    if (!element) return

    const handleScroll = () => {
      previousScrollTop.current = element.scrollTop
    }

    element.addEventListener('scroll', handleScroll, { passive: true })
    return () => element.removeEventListener('scroll', handleScroll)
  }, [parentRef])

  // Restore scroll position on browser back navigation
  useEffect(() => {
    const handlePopState = () => {
      const element = parentRef.current
      if (element && previousScrollTop.current > 0) {
        element.scrollTop = previousScrollTop.current
      }
    }

    window.addEventListener('popstate', handlePopState)
    return () => window.removeEventListener('popstate', handlePopState)
  }, [parentRef])

  return {
    savedScrollPosition: previousScrollTop.current,
  }
}

// Component for rendering a virtualized row with absolute positioning
export interface VirtualizedRowProps {
  virtualRow: VirtualItem
  children: React.ReactNode
  className?: string
}

export function VirtualizedRow({ virtualRow, children, className = '' }: VirtualizedRowProps) {
  return (
    <div
      style={{
        position: 'absolute',
        top: 0,
        left: 0,
        width: '100%',
        height: `${virtualRow.size}px`,
        transform: `translateY(${virtualRow.start}px)`,
      }}
      className={className}
    >
      {children}
    </div>
  )
}

// Constants export for consumers
export const VIRTUALIZED_TABLE_DEFAULTS = {
  rowHeight: DEFAULT_ROW_HEIGHT,
  overscan: 10,
  containerHeight: 600,
} as const
```

Key implementation details:
- Fixed row height (52px) per CONTEXT decision - simpler and faster than dynamic
- Overscan of 10 rows for smooth scrolling without blank space
- useSmartScrollReset handles scroll position logic:
  - Reset to top on filter/sort changes
  - Preserve position on data refresh
  - Restore position on browser back navigation
- VirtualizedRow component handles positioning math
- Exports defaults for consistency across tables
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. File exports useVirtualizedTable, useSmartScrollReset, VirtualizedRow, VIRTUALIZED_TABLE_DEFAULTS
  </verify>
  <done>
- useVirtualizedTable hook created with TanStack Virtual integration
- useSmartScrollReset hook handles scroll position logic
- VirtualizedRow component for consistent row positioning
- Fixed row height (52px) per CONTEXT decision
- Overscan of 10 rows for smooth scrolling
  </done>
</task>

</tasks>

<verification>
After task completion:
```bash
npx tsc --noEmit
```
Check that hook exports match expected: useVirtualizedTable, useSmartScrollReset, VirtualizedRow, VIRTUALIZED_TABLE_DEFAULTS
</verification>

<success_criteria>
- Hook integrates TanStack Table with TanStack Virtual
- Smart scroll behavior: reset on filter/sort, preserve on refresh, restore on back
- Fixed row height used for faster rendering
- Exports helper components and constants
- TypeScript types correct
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-table-features/03-05-SUMMARY.md`
</output>
