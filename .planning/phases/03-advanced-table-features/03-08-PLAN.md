---
phase: 03-advanced-table-features
plan: 08
type: execute
wave: 3
depends_on: ["03-02", "03-07"]
files_modified:
  - src/hooks/useTableKeyboard.tsx
  - src/app/(platform)/users/components/UserTable.tsx
autonomous: true

must_haves:
  truths:
    - "Staff can use j/k to navigate rows in the table"
    - "Staff can use Space to select the current row"
    - "Staff can use Shift+j/k to extend selection"
    - "Staff can use Cmd+A to select all rows"
    - "Shortcuts only active when table is focused"
  artifacts:
    - path: "src/hooks/useTableKeyboard.tsx"
      provides: "Table keyboard navigation hook"
      exports: ["useTableKeyboard"]
      min_lines: 80
    - path: "src/app/(platform)/users/components/UserTable.tsx"
      provides: "Table with keyboard navigation"
      contains: "useTableKeyboard"
  key_links:
    - from: "src/hooks/useTableKeyboard.tsx"
      to: "src/components/keyboard-shortcuts/ShortcutProvider.tsx"
      via: "useShortcutScope"
      pattern: "useShortcutScope"
    - from: "src/app/(platform)/users/components/UserTable.tsx"
      to: "src/hooks/useTableKeyboard.tsx"
      via: "useTableKeyboard hook"
      pattern: "useTableKeyboard"
---

<objective>
Create table keyboard navigation hook and integrate with UserTable for power-user row selection.

Purpose: Enable staff to quickly navigate and select rows using j/k keys, Space for selection, and Shift for range selection. This matches UX from tools like Linear and GitHub.
Output: Table responds to keyboard navigation when focused.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-table-features/03-CONTEXT.md
@src/app/(platform)/users/components/UserTable.tsx
@src/components/keyboard-shortcuts/ShortcutProvider.tsx
@src/hooks/useKeyboardShortcuts.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create useTableKeyboard hook</name>
  <files>src/hooks/useTableKeyboard.tsx</files>
  <action>
Create `src/hooks/useTableKeyboard.tsx`:

```typescript
'use client'

import { useState, useCallback, useEffect, useRef } from 'react'
import { useHotkeys } from 'react-hotkeys-hook'
import { useShortcutScope } from './useKeyboardShortcuts'

interface UseTableKeyboardOptions<T> {
  items: T[]
  onNavigate?: (item: T, index: number) => void
  onSelect?: (selectedItems: T[], indices: number[]) => void
  onAction?: (item: T) => void  // Called on Enter
  enabled?: boolean
}

interface UseTableKeyboardReturn<T> {
  focusedIndex: number
  selectedIndices: Set<number>
  tableRef: React.RefObject<HTMLDivElement>
  isFocused: boolean
  setFocusedIndex: (index: number) => void
  clearSelection: () => void
  selectAll: () => void
  toggleSelection: (index: number) => void
}

export function useTableKeyboard<T>({
  items,
  onNavigate,
  onSelect,
  onAction,
  enabled = true,
}: UseTableKeyboardOptions<T>): UseTableKeyboardReturn<T> {
  const [focusedIndex, setFocusedIndex] = useState(-1)
  const [selectedIndices, setSelectedIndices] = useState<Set<number>>(new Set())
  const [isFocused, setIsFocused] = useState(false)
  const tableRef = useRef<HTMLDivElement>(null)
  const { activate, deactivate } = useShortcutScope('table')

  // Track focus state
  useEffect(() => {
    const element = tableRef.current
    if (!element) return

    const handleFocus = () => {
      setIsFocused(true)
      activate()
    }
    const handleBlur = (e: FocusEvent) => {
      // Only deactivate if focus is leaving the table entirely
      if (!element.contains(e.relatedTarget as Node)) {
        setIsFocused(false)
        deactivate()
      }
    }

    element.addEventListener('focus', handleFocus)
    element.addEventListener('blur', handleBlur)
    return () => {
      element.removeEventListener('focus', handleFocus)
      element.removeEventListener('blur', handleBlur)
    }
  }, [activate, deactivate])

  // Navigate down (j)
  useHotkeys('j', () => {
    if (!enabled || !isFocused || items.length === 0) return
    const newIndex = Math.min(focusedIndex + 1, items.length - 1)
    setFocusedIndex(newIndex)
    onNavigate?.(items[newIndex], newIndex)
  }, {
    enabled: enabled && isFocused,
    preventDefault: true,
  }, [items, focusedIndex, enabled, isFocused, onNavigate])

  // Navigate up (k)
  useHotkeys('k', () => {
    if (!enabled || !isFocused || items.length === 0) return
    const newIndex = Math.max(focusedIndex - 1, 0)
    setFocusedIndex(newIndex)
    onNavigate?.(items[newIndex], newIndex)
  }, {
    enabled: enabled && isFocused,
    preventDefault: true,
  }, [items, focusedIndex, enabled, isFocused, onNavigate])

  // Toggle selection (Space)
  useHotkeys('space', () => {
    if (!enabled || !isFocused || focusedIndex < 0) return
    toggleSelection(focusedIndex)
  }, {
    enabled: enabled && isFocused,
    preventDefault: true,
  }, [focusedIndex, enabled, isFocused])

  // Extend selection down (Shift+j)
  useHotkeys('shift+j', () => {
    if (!enabled || !isFocused || items.length === 0) return
    const newIndex = Math.min(focusedIndex + 1, items.length - 1)
    setFocusedIndex(newIndex)
    setSelectedIndices(prev => {
      const next = new Set(prev)
      next.add(newIndex)
      return next
    })
    notifySelection()
  }, {
    enabled: enabled && isFocused,
    preventDefault: true,
  }, [items, focusedIndex, enabled, isFocused])

  // Extend selection up (Shift+k)
  useHotkeys('shift+k', () => {
    if (!enabled || !isFocused || items.length === 0) return
    const newIndex = Math.max(focusedIndex - 1, 0)
    setFocusedIndex(newIndex)
    setSelectedIndices(prev => {
      const next = new Set(prev)
      next.add(newIndex)
      return next
    })
    notifySelection()
  }, {
    enabled: enabled && isFocused,
    preventDefault: true,
  }, [items, focusedIndex, enabled, isFocused])

  // Select all (Cmd+A)
  useHotkeys('mod+a', (e) => {
    if (!enabled || !isFocused) return
    e.preventDefault()
    selectAll()
  }, {
    enabled: enabled && isFocused,
    preventDefault: true,
  }, [items, enabled, isFocused])

  // Open action (Enter)
  useHotkeys('enter', () => {
    if (!enabled || !isFocused || focusedIndex < 0) return
    onAction?.(items[focusedIndex])
  }, {
    enabled: enabled && isFocused,
    preventDefault: true,
  }, [items, focusedIndex, enabled, isFocused, onAction])

  // Clear selection (Escape)
  useHotkeys('escape', () => {
    if (!enabled || !isFocused) return
    clearSelection()
  }, {
    enabled: enabled && isFocused,
    preventDefault: true,
  }, [enabled, isFocused])

  // Helper functions
  const toggleSelection = useCallback((index: number) => {
    setSelectedIndices(prev => {
      const next = new Set(prev)
      if (next.has(index)) {
        next.delete(index)
      } else {
        next.add(index)
      }
      return next
    })
  }, [])

  const clearSelection = useCallback(() => {
    setSelectedIndices(new Set())
    setFocusedIndex(-1)
    onSelect?.([], [])
  }, [onSelect])

  const selectAll = useCallback(() => {
    const allIndices = new Set(items.map((_, i) => i))
    setSelectedIndices(allIndices)
    onSelect?.(items, Array.from(allIndices))
  }, [items, onSelect])

  const notifySelection = useCallback(() => {
    const indices = Array.from(selectedIndices)
    const selectedItems = indices.map(i => items[i])
    onSelect?.(selectedItems, indices)
  }, [selectedIndices, items, onSelect])

  // Notify on selection change
  useEffect(() => {
    notifySelection()
  }, [selectedIndices]) // eslint-disable-line react-hooks/exhaustive-deps

  return {
    focusedIndex,
    selectedIndices,
    tableRef,
    isFocused,
    setFocusedIndex,
    clearSelection,
    selectAll,
    toggleSelection,
  }
}
```

Key implementation:
- j/k for up/down navigation
- Space to toggle selection on current row
- Shift+j/k to extend selection while moving
- Cmd+A to select all
- Enter to perform action on focused row
- Escape to clear selection
- Shortcuts only active when table is focused (checks isFocused)
- Uses useShortcutScope to register 'table' scope
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. Hook exports useTableKeyboard
  </verify>
  <done>useTableKeyboard hook created with j/k navigation, Space selection, Shift range extension, Cmd+A select all</done>
</task>

<task type="auto">
  <name>Task 2: Integrate keyboard navigation with UserTable</name>
  <files>src/app/(platform)/users/components/UserTable.tsx</files>
  <action>
Update `src/app/(platform)/users/components/UserTable.tsx` to use keyboard navigation:

1. Import useTableKeyboard hook
2. Add keyboard hook with items, onNavigate, onAction
3. Add tabIndex to table container for focus
4. Add visual indicator for focused row (ring-2 ring-platform-primary)
5. Add visual indicator for selected rows (bg-platform-primary/10)

Key additions:

Import:
```typescript
import { useTableKeyboard } from '@/hooks/useTableKeyboard'
```

In component, after virtualizedTable setup:
```typescript
// Keyboard navigation
const keyboard = useTableKeyboard({
  items: data,
  onNavigate: (user, index) => {
    // Scroll focused row into view
    virtualizedTable.scrollToIndex(index)
  },
  onAction: (user) => {
    router.push(`/users/${user.id}`)
  },
  enabled: data.length > 0,
})
```

Update table container:
```typescript
<div
  ref={(el) => {
    // Merge refs
    (virtualizedTable.parentRef as any).current = el
    ;(keyboard.tableRef as any).current = el
  }}
  tabIndex={0}
  className="overflow-auto bg-white focus:outline-none focus:ring-2 focus:ring-platform-primary focus:ring-inset"
  style={{ height: '600px' }}
>
```

Update row rendering to show focus/selection state:
```typescript
<VirtualizedRow
  key={row.id}
  virtualRow={virtualRow}
  className={`
    cursor-pointer transition-colors
    ${keyboard.focusedIndex === virtualRow.index ? 'ring-2 ring-inset ring-platform-primary' : ''}
    ${keyboard.selectedIndices.has(virtualRow.index) ? 'bg-platform-primary/10' : 'hover:bg-gray-50'}
  `}
>
```
  </action>
  <verify>
1. `npm run build` passes
2. Run dev server, navigate to /users
3. Click on table to focus, then use j/k to navigate - focus ring should move
4. Press Space - row should get selected (background color)
5. Press Enter on focused row - should navigate to detail
  </verify>
  <done>
- UserTable integrated with keyboard navigation
- Focus indicator shows current row
- Selection indicator shows selected rows
- j/k navigation scrolls into view
- Enter navigates to detail page
  </done>
</task>

</tasks>

<verification>
After both tasks:
```bash
npm run build
npm run dev
```
Test keyboard navigation:
1. Navigate to /users
2. Click table to focus (focus ring should appear)
3. Press j - focus should move to first row
4. Press j/k repeatedly - focus should move up/down
5. Press Space - row should become selected (colored background)
6. Press Shift+j/k - selection should extend
7. Press Cmd+A - all visible rows should select
8. Press Escape - selection should clear
9. Press Enter on focused row - should navigate to detail
</verification>

<success_criteria>
- j/k navigation works
- Space toggles selection
- Shift+j/k extends selection
- Cmd+A selects all
- Enter navigates to focused row detail
- Escape clears selection
- Focus indicator visible
- Selection indicator visible
- Shortcuts only work when table focused
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-table-features/03-08-SUMMARY.md`
</output>
