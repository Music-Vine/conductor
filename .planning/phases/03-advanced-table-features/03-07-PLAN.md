---
phase: 03-advanced-table-features
plan: 07
type: execute
wave: 3
depends_on: ["03-04", "03-05"]
files_modified:
  - src/app/(platform)/users/components/UserTable.tsx
autonomous: true

must_haves:
  truths:
    - "User table uses virtualization for row rendering"
    - "Large datasets (10k+ rows) scroll smoothly at 60FPS"
    - "Empty state replaces table when no results"
    - "Scroll resets to top when filters change"
  artifacts:
    - path: "src/app/(platform)/users/components/UserTable.tsx"
      provides: "Virtualized user table"
      contains: "useVirtualizedTable"
      min_lines: 150
  key_links:
    - from: "src/app/(platform)/users/components/UserTable.tsx"
      to: "src/hooks/useVirtualizedTable.tsx"
      via: "useVirtualizedTable hook"
      pattern: "useVirtualizedTable"
    - from: "src/app/(platform)/users/components/UserTable.tsx"
      to: "src/components/empty-states/EmptyState.tsx"
      via: "NoResultsEmptyState component"
      pattern: "NoResultsEmptyState"
---

<objective>
Refactor UserTable to use virtualization for smooth rendering of large datasets and proper empty states.

Purpose: Enable staff to browse 3M+ user accounts without performance issues. Virtualization only renders visible rows, maintaining 60FPS even with massive datasets.
Output: Virtualized UserTable with proper empty state handling.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-table-features/03-CONTEXT.md
@src/app/(platform)/users/components/UserTable.tsx
@src/hooks/useVirtualizedTable.tsx
@src/components/empty-states/EmptyState.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Refactor UserTable with virtualization</name>
  <files>src/app/(platform)/users/components/UserTable.tsx</files>
  <action>
Refactor `src/app/(platform)/users/components/UserTable.tsx` to use virtualization:

```typescript
'use client'

import { useRouter, useSearchParams } from 'next/navigation'
import {
  createColumnHelper,
  flexRender,
  getCoreRowModel,
  useReactTable,
} from '@tanstack/react-table'
import type { UserListItem } from '@/types/user'
import { UserRowActions } from './UserRowActions'
import { useVirtualizedTable, useSmartScrollReset, VirtualizedRow, VIRTUALIZED_TABLE_DEFAULTS } from '@/hooks/useVirtualizedTable'
import { NoResultsEmptyState } from '@/components/empty-states/EmptyState'

interface UserTableProps {
  data: UserListItem[]
  pagination: {
    page: number
    pageSize: number
    totalPages: number
    totalItems: number
  }
}

const columnHelper = createColumnHelper<UserListItem>()

const columns = [
  columnHelper.accessor((row) => ({ email: row.email, name: row.name }), {
    id: 'user',
    header: 'User',
    cell: (info) => {
      const { email, name } = info.getValue()
      return (
        <div className="flex flex-col">
          <span className="font-medium text-gray-900">{email}</span>
          {name && <span className="text-sm text-gray-500">{name}</span>}
        </div>
      )
    },
  }),
  columnHelper.accessor('status', {
    header: 'Status',
    cell: (info) => {
      const status = info.getValue()
      const isActive = status === 'active'
      return (
        <span
          className={`inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium ${
            isActive
              ? 'bg-green-100 text-green-800'
              : 'bg-red-100 text-red-800'
          }`}
        >
          {isActive ? 'Active' : 'Suspended'}
        </span>
      )
    },
  }),
  columnHelper.accessor('subscriptionTier', {
    header: 'Subscription',
    cell: (info) => {
      const tier = info.getValue()
      const tierLabels: Record<string, string> = {
        free: 'Free',
        essentials: 'Essentials',
        creator: 'Creator',
        pro: 'Pro',
        enterprise: 'Enterprise',
      }
      const tierColors: Record<string, string> = {
        free: 'text-gray-600',
        essentials: 'text-gray-500',
        creator: 'text-blue-600',
        pro: 'text-green-600',
        enterprise: 'text-gray-900',
      }
      return (
        <span className={`font-medium ${tierColors[tier] || 'text-gray-600'}`}>
          {tierLabels[tier] || tier}
        </span>
      )
    },
  }),
  columnHelper.accessor('lastLoginAt', {
    header: 'Last Login',
    cell: (info) => {
      const lastLogin = info.getValue()
      if (!lastLogin) return <span className="text-gray-400">Never</span>

      const date = new Date(lastLogin)
      const now = new Date()
      const diffMs = now.getTime() - date.getTime()
      const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24))

      if (diffDays === 0) {
        return <span className="text-gray-700">Today</span>
      } else if (diffDays === 1) {
        return <span className="text-gray-700">Yesterday</span>
      } else if (diffDays < 7) {
        return <span className="text-gray-700">{diffDays} days ago</span>
      } else if (diffDays < 30) {
        const weeks = Math.floor(diffDays / 7)
        return <span className="text-gray-600">{weeks} {weeks === 1 ? 'week' : 'weeks'} ago</span>
      } else if (diffDays < 365) {
        const months = Math.floor(diffDays / 30)
        return <span className="text-gray-600">{months} {months === 1 ? 'month' : 'months'} ago</span>
      } else {
        return (
          <span className="text-gray-500">
            {date.toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric',
            })}
          </span>
        )
      }
    },
  }),
  columnHelper.display({
    id: 'actions',
    header: 'Actions',
    cell: (info) => <UserRowActions user={info.row.original} />,
  }),
]

export function UserTable({ data, pagination }: UserTableProps) {
  const router = useRouter()
  const searchParams = useSearchParams()

  // Get current filter state for scroll reset detection
  const currentQuery = searchParams.get('query') || ''
  const currentStatus = searchParams.get('status') || ''
  const currentTier = searchParams.get('tier') || ''

  // Defensive check - show empty state if no data
  if (!data || !Array.isArray(data)) {
    return <NoResultsEmptyState />
  }

  if (!pagination) {
    return <NoResultsEmptyState />
  }

  // Show empty state when no results (replaces full table per best practices)
  if (data.length === 0) {
    const hasFilters = currentQuery || currentStatus || currentTier
    return (
      <NoResultsEmptyState
        searchQuery={currentQuery || undefined}
        onClearFilters={hasFilters ? () => router.push('/users') : undefined}
      />
    )
  }

  const table = useReactTable({
    data,
    columns,
    getCoreRowModel: getCoreRowModel(),
    manualPagination: true,
    manualFiltering: true,
    manualSorting: true,
    pageCount: pagination.totalPages,
    state: {
      pagination: {
        pageIndex: pagination.page - 1,
        pageSize: pagination.pageSize,
      },
    },
  })

  // Setup virtualization
  const virtualizedTable = useVirtualizedTable({
    table,
    rowHeight: VIRTUALIZED_TABLE_DEFAULTS.rowHeight,
    overscan: VIRTUALIZED_TABLE_DEFAULTS.overscan,
    containerHeight: 600,
  })

  // Smart scroll reset on filter changes
  useSmartScrollReset(virtualizedTable, [currentQuery, currentStatus, currentTier, pagination.page])

  const { parentRef, virtualRows, totalHeight, rows } = virtualizedTable

  function handleRowClick(userId: string, event: React.MouseEvent) {
    // Don't navigate if clicking on actions dropdown
    if ((event.target as HTMLElement).closest('[data-actions]')) {
      return
    }
    router.push(`/users/${userId}`)
  }

  return (
    <div className="overflow-hidden rounded-lg border border-gray-200">
      {/* Fixed header */}
      <div className="bg-gray-50 border-b border-gray-200">
        <table className="w-full border-collapse">
          <thead>
            {table.getHeaderGroups().map((headerGroup) => (
              <tr key={headerGroup.id}>
                {headerGroup.headers.map((header) => (
                  <th
                    key={header.id}
                    className="px-6 py-3 text-left text-xs font-medium uppercase tracking-wider text-gray-700"
                    style={{ width: header.getSize() }}
                  >
                    {header.isPlaceholder
                      ? null
                      : flexRender(
                          header.column.columnDef.header,
                          header.getContext()
                        )}
                  </th>
                ))}
              </tr>
            ))}
          </thead>
        </table>
      </div>

      {/* Virtualized body */}
      <div
        ref={parentRef}
        className="overflow-auto bg-white"
        style={{ height: '600px' }}
      >
        <div
          style={{
            height: `${totalHeight}px`,
            width: '100%',
            position: 'relative',
          }}
        >
          {virtualRows.map((virtualRow) => {
            const row = rows[virtualRow.index]
            return (
              <VirtualizedRow
                key={row.id}
                virtualRow={virtualRow}
                className="cursor-pointer transition-colors hover:bg-gray-50"
              >
                <table className="w-full border-collapse">
                  <tbody>
                    <tr
                      onClick={(e) => handleRowClick(row.original.id, e)}
                      className="border-b border-gray-100"
                    >
                      {row.getVisibleCells().map((cell) => (
                        <td
                          key={cell.id}
                          className="whitespace-nowrap px-6 py-4 text-sm"
                          style={{ width: cell.column.getSize() }}
                        >
                          {flexRender(cell.column.columnDef.cell, cell.getContext())}
                        </td>
                      ))}
                    </tr>
                  </tbody>
                </table>
              </VirtualizedRow>
            )
          })}
        </div>
      </div>
    </div>
  )
}
```

Key changes from original:
1. Import useVirtualizedTable, useSmartScrollReset, VirtualizedRow from hook
2. Import NoResultsEmptyState for empty state handling
3. Return empty state BEFORE table setup when data.length === 0
4. Setup virtualization with useVirtualizedTable hook
5. Use useSmartScrollReset with filter dependencies
6. Render fixed header separate from virtualized body
7. Use VirtualizedRow for absolute positioning of rows
8. Fixed height container (600px) for virtualization
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Start dev server, navigate to /users - table should render
4. With filters that return no results, empty state should show
  </verify>
  <done>
- UserTable refactored to use virtualization
- Empty state shown when no results (replaces full table)
- Scroll resets on filter/sort changes
- Fixed header stays visible while scrolling
- Row click navigation preserved
  </done>
</task>

</tasks>

<verification>
After task completion:
```bash
npm run build
npm run dev
```
Test:
1. Navigate to /users - table should load normally
2. Scroll through the table - should be smooth
3. Apply filters that return no results - empty state should appear
4. Clear filters - table should reappear
5. Apply filters - scroll position should reset to top
</verification>

<success_criteria>
- UserTable uses virtualization hook
- Empty state completely replaces table when no data
- Scroll behavior matches CONTEXT requirements
- Build passes
- Visual appearance unchanged (same columns, styling)
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-table-features/03-07-SUMMARY.md`
</output>
