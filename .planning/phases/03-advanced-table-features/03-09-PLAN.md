---
phase: 03-advanced-table-features
plan: 09
type: execute
wave: 4
depends_on: ["03-03", "03-06"]
files_modified:
  - src/components/command-palette/CommandPalette.tsx
  - src/components/command-palette/SearchResults.tsx
autonomous: true

must_haves:
  truths:
    - "Command palette shows global search results"
    - "Results display entity type icons and labels"
    - "Loading state shows while searching"
    - "No results message shows when empty"
    - "Selecting a result navigates to entity"
  artifacts:
    - path: "src/components/command-palette/SearchResults.tsx"
      provides: "Search result display component"
      exports: ["SearchResults"]
      min_lines: 40
    - path: "src/components/command-palette/CommandPalette.tsx"
      provides: "Command palette with search integration"
      contains: "useGlobalSearch"
  key_links:
    - from: "src/components/command-palette/CommandPalette.tsx"
      to: "src/hooks/useGlobalSearch.tsx"
      via: "useGlobalSearch hook"
      pattern: "useGlobalSearch"
    - from: "src/components/command-palette/SearchResults.tsx"
      to: "src/components/command-palette/CommandPalette.tsx"
      via: "imported and rendered"
      pattern: "SearchResults"
---

<objective>
Integrate global search into command palette so staff can find users, assets, and payees by typing.

Purpose: Make the command palette the primary way for power users to find anything in the system. One shortcut (Cmd+K) provides access to navigation AND search.
Output: Command palette shows search results as user types.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-advanced-table-features/03-CONTEXT.md
@src/components/command-palette/CommandPalette.tsx
@src/hooks/useGlobalSearch.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SearchResults component</name>
  <files>src/components/command-palette/SearchResults.tsx</files>
  <action>
Create `src/components/command-palette/SearchResults.tsx`:

```typescript
'use client'

import { Command } from 'cmdk'
import type { SearchResultItem } from '@/hooks/useGlobalSearch'

interface SearchResultsProps {
  results: SearchResultItem[]
  isLoading: boolean
  onSelect: (result: SearchResultItem) => void
}

// Icons for each entity type
const entityIcons: Record<string, React.ReactNode> = {
  user: (
    <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
    </svg>
  ),
  asset: (
    <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 19V6l12-3v13M9 19c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zm12-3c0 1.105-1.343 2-3 2s-3-.895-3-2 1.343-2 3-2 3 .895 3 2zM9 10l12-3" />
    </svg>
  ),
  payee: (
    <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
    </svg>
  ),
}

const entityLabels: Record<string, string> = {
  user: 'User',
  asset: 'Asset',
  payee: 'Payee',
}

export function SearchResults({ results, isLoading, onSelect }: SearchResultsProps) {
  if (isLoading) {
    return (
      <div className="py-6 text-center">
        <div className="inline-block h-5 w-5 animate-spin rounded-full border-2 border-gray-300 border-t-gray-600" />
        <p className="mt-2 text-sm text-gray-500">Searching...</p>
      </div>
    )
  }

  if (results.length === 0) {
    return null // Let Command.Empty handle this
  }

  return (
    <Command.Group heading="Search Results" className="px-2 py-1.5">
      <span className="text-xs font-medium text-gray-500">Search Results</span>
      {results.map((result) => (
        <Command.Item
          key={`${result.type}-${result.id}`}
          value={`${result.title} ${result.subtitle}`}
          onSelect={() => onSelect(result)}
          className="flex cursor-pointer items-center gap-3 rounded-lg px-3 py-2 text-sm aria-selected:bg-gray-100"
        >
          <span className="flex h-8 w-8 items-center justify-center rounded-lg bg-gray-100 text-gray-600">
            {entityIcons[result.type]}
          </span>
          <div className="flex-1 min-w-0">
            <div className="font-medium text-gray-900 truncate">{result.title}</div>
            <div className="text-xs text-gray-500 truncate">{result.subtitle}</div>
          </div>
          <span className="text-xs text-gray-400 shrink-0">
            {entityLabels[result.type]}
          </span>
        </Command.Item>
      ))}
    </Command.Group>
  )
}
```

Key implementation:
- Icons for each entity type (user, asset, payee)
- Loading spinner while searching
- Entity type label on the right
- Title and subtitle truncate for long text
- Uses cmdk's Command.Item for keyboard navigation
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. File exports SearchResults
  </verify>
  <done>SearchResults component created with entity icons, loading state, and type labels</done>
</task>

<task type="auto">
  <name>Task 2: Integrate search into CommandPalette</name>
  <files>src/components/command-palette/CommandPalette.tsx</files>
  <action>
Update `src/components/command-palette/CommandPalette.tsx` to include global search:

1. Import useGlobalSearch hook and SearchResults component
2. Add search state and hook integration
3. Show SearchResults when query has results
4. Handle result selection (navigate to entity)

Key additions:

Add imports:
```typescript
import { useGlobalSearch } from '@/hooks/useGlobalSearch'
import { SearchResults } from './SearchResults'
import { useState } from 'react'
```

Add state and search hook inside component:
```typescript
const [searchQuery, setSearchQuery] = useState('')
const { results, isLoading, isSearching } = useGlobalSearch(searchQuery)
```

Update Command.Input to track query:
```typescript
<Command.Input
  placeholder="Search for actions or pages..."
  value={searchQuery}
  onValueChange={setSearchQuery}
  className="w-full border-b border-gray-200 px-4 py-3 text-base outline-none placeholder:text-gray-400"
/>
```

Add SearchResults before the Navigation group (shows when typing):
```typescript
{searchQuery.length >= 2 && (
  <SearchResults
    results={results}
    isLoading={isLoading || isSearching}
    onSelect={(result) => {
      setOpen(false)
      setSearchQuery('')
      router.push(result.url)
    }}
  />
)}
```

Add separator between search results and navigation (when both visible):
```typescript
{searchQuery.length >= 2 && results.length > 0 && (
  <Command.Separator className="my-2 h-px bg-gray-200" />
)}
```

Clear search query when dialog closes:
```typescript
// In useEffect or onOpenChange handler
useEffect(() => {
  if (!open) {
    setSearchQuery('')
  }
}, [open])
```

Full updated component should have:
- Search results appear as you type (after 2 chars)
- Navigation items always visible below
- Loading state while searching
- Results navigable via arrow keys
- Selecting result navigates and closes palette
  </action>
  <verify>
1. `npm run build` passes
2. Run dev server, press Cmd+K
3. Type "john" - should see search results appear
4. Arrow down to a result, press Enter - should navigate
5. Clear query - should see navigation items only
  </verify>
  <done>
- Command palette integrated with global search
- Search results appear while typing
- Navigation items remain visible
- Results show entity type and navigate on select
- Query clears when palette closes
  </done>
</task>

</tasks>

<verification>
After both tasks:
```bash
npm run build
npm run dev
```
Test:
1. Press Cmd+K
2. Type "john" - search results should appear above navigation
3. Results should show user/asset/payee icons
4. Use arrow keys to select a result
5. Press Enter - should navigate to entity detail
6. Press Cmd+K again - query should be cleared
7. Navigation items should always be visible below search
</verification>

<success_criteria>
- Search results appear in command palette
- Results have entity type icons
- Loading spinner shows while searching
- Navigation items remain below search results
- Selecting result navigates to correct page
- Query clears when palette closes
</success_criteria>

<output>
After completion, create `.planning/phases/03-advanced-table-features/03-09-SUMMARY.md`
</output>
