---
phase: 05-bulk-operations
plan: 06
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - src/app/(platform)/users/components/UserTable.tsx
  - src/app/(platform)/users/components/UserListClient.tsx
  - src/app/(platform)/users/page.tsx
  - src/app/(platform)/users/components/index.ts
autonomous: true

must_haves:
  truths:
    - "User table shows checkbox column for selection"
    - "Header checkbox selects all items matching current filters across all pages (via /bulk/ids endpoint)"
    - "Shift+Click selects range between last selected and clicked row, works across pages"
    - "Selection clears when filters change"
    - "Floating action bar appears with user-specific actions (suspend, unsuspend, delete)"
  artifacts:
    - path: "src/app/(platform)/users/components/UserTable.tsx"
      provides: "UserTable with bulk selection support"
      contains: "useBulkSelection"
    - path: "src/app/(platform)/users/components/UserListClient.tsx"
      provides: "Client wrapper with bulk operations"
      exports: ["UserListClient"]
  key_links:
    - from: "src/app/(platform)/users/components/UserTable.tsx"
      to: "src/hooks/useBulkSelection.ts"
      via: "Selection state hook"
      pattern: "useBulkSelection"
---

<objective>
Integrate bulk selection and operations into the UserTable component.

Purpose: Enable staff to select multiple users and perform bulk operations (suspend, unsuspend, delete) per CONTEXT decisions.

Output: UserTable with checkbox selection, Shift+Click range selection, and connected BulkActionBar with user-specific actions.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bulk-operations/05-CONTEXT.md
@.planning/phases/05-bulk-operations/05-RESEARCH.md

# Prior plan outputs
@src/hooks/useBulkSelection.ts
@src/hooks/useBulkProgress.ts
@src/components/bulk-operations/BulkActionBar.tsx
@src/components/bulk-operations/BulkConfirmDialog.tsx
@src/components/bulk-operations/TypeToConfirmDialog.tsx

# Asset implementation for reference
@src/app/(platform)/assets/components/AssetListClient.tsx

# Current implementation
@src/app/(platform)/users/components/UserTable.tsx
@src/app/(platform)/users/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkbox column and selection to UserTable</name>
  <files>src/app/(platform)/users/components/UserTable.tsx</files>
  <action>
Update `src/app/(platform)/users/components/UserTable.tsx` to add bulk selection support, following the same pattern as AssetTable:

**Changes:**

1. Import new hooks:
```typescript
import { useBulkSelection } from '@/hooks/useBulkSelection'
import { useSearchParams } from 'next/navigation'
import { useRef, useEffect } from 'react'
```

2. Update UserTableProps:
```typescript
interface UserTableProps {
  data: UserListItem[]
  pagination: {
    page: number
    pageSize: number
    totalPages: number
    totalItems: number
  }
  onSelectionChange?: (selectedIds: string[]) => void
}
```

3. Add state and fetch function for all filtered IDs (for Select All and cross-page Shift+Click):
```typescript
const [allFilteredIds, setAllFilteredIds] = useState<string[] | null>(null)
const [isLoadingAllIds, setIsLoadingAllIds] = useState(false)

// Fetch all filtered IDs from /bulk/ids endpoint
const fetchAllFilteredIds = useCallback(async (): Promise<string[]> => {
  if (allFilteredIds) return allFilteredIds // Cache hit

  setIsLoadingAllIds(true)
  try {
    const params = new URLSearchParams(searchParams.toString())
    const response = await fetch(`/api/users/bulk/ids?${params}`)
    const { ids } = await response.json()
    setAllFilteredIds(ids)
    return ids
  } finally {
    setIsLoadingAllIds(false)
  }
}, [searchParams, allFilteredIds])

// Clear cached IDs when filters change
useEffect(() => {
  setAllFilteredIds(null)
}, [searchParams])
```

4. Add checkbox column as first column:
```typescript
const checkboxColumn = columnHelper.display({
  id: 'select',
  header: () => null, // Header handled separately
  size: 48,
  cell: ({ row }) => {
    const isSelected = bulkSelection.isSelected(row.original.id)
    return (
      <div className="flex items-center justify-center">
        <input
          type="checkbox"
          checked={isSelected}
          onChange={() => bulkSelection.toggle(row.original.id)}
          onClick={async (e) => {
            // Handle Shift+Click for range selection (works across pages)
            if (e.shiftKey && bulkSelection.lastSelectedId) {
              e.preventDefault()
              // Fetch all filtered IDs for cross-page range selection
              const orderedIds = await fetchAllFilteredIds()
              bulkSelection.selectRange(bulkSelection.lastSelectedId, row.original.id, orderedIds)
            }
          }}
          className="h-4 w-4 rounded border-gray-300 text-platform-primary focus:ring-platform-primary"
        />
      </div>
    )
  },
})
```

4. Update columns array to include checkbox column first.

5. Initialize useBulkSelection in component:
```typescript
const searchParams = useSearchParams()

const bulkSelection = useBulkSelection({
  entityType: 'user',
  filterParams: searchParams,
  totalFilteredCount: pagination.totalItems,
})

// Notify parent of selection changes
useEffect(() => {
  onSelectionChange?.(Array.from(bulkSelection.selectedIds))
}, [bulkSelection.selectedIds, onSelectionChange])
```

6. Update gridTemplateColumns to include checkbox column (48px):
```typescript
// Original: '300px 120px 150px 150px 100px'
// New: '48px 300px 120px 150px 150px 100px'
const gridTemplateColumns = '48px 300px 120px 150px 150px 100px'
```

7. Add header checkbox with indeterminate state:
```typescript
const headerCheckboxRef = useRef<HTMLInputElement>(null)
useEffect(() => {
  if (headerCheckboxRef.current) {
    headerCheckboxRef.current.indeterminate = bulkSelection.selectedCount > 0 && !bulkSelection.isAllSelected
  }
}, [bulkSelection.selectedCount, bulkSelection.isAllSelected])

// In header row:
<div className="flex items-center justify-center px-3">
  <input
    ref={headerCheckboxRef}
    type="checkbox"
    checked={bulkSelection.isAllSelected && bulkSelection.selectedCount > 0}
    disabled={isLoadingAllIds}
    onChange={async () => {
      if (bulkSelection.selectedCount > 0) {
        bulkSelection.clearSelection()
      } else {
        // Select ALL filtered IDs across all pages (per CONTEXT decision)
        const allIds = await fetchAllFilteredIds()
        bulkSelection.selectAll(allIds)
      }
    }}
    className="h-4 w-4 rounded border-gray-300 text-platform-primary focus:ring-platform-primary disabled:opacity-50"
  />
</div>
```

**IMPORTANT:** The header checkbox MUST fetch ALL filtered IDs from `/api/users/bulk/ids` endpoint, NOT just current page IDs. This honors the CONTEXT decision: "Select All selects all items matching current filters across all pages."

8. Update row rendering to show selected state with `bg-platform-primary/10` background.
  </action>
  <verify>
1. npx tsc --noEmit passes
2. Checkbox column appears in user table
  </verify>
  <done>
- UserTable has checkbox column for row selection
- Shift+Click enables range selection across pages (fetches all filtered IDs)
- Header checkbox selects ALL filtered items across all pages (via /bulk/ids endpoint)
- Selected rows highlighted
  </done>
</task>

<task type="auto">
  <name>Task 2: Create UserListClient and integrate BulkActionBar</name>
  <files>src/app/(platform)/users/components/UserListClient.tsx, src/app/(platform)/users/page.tsx, src/app/(platform)/users/components/index.ts</files>
  <action>
Create `src/app/(platform)/users/components/UserListClient.tsx` to wrap UserTable with bulk operations:

```typescript
'use client'

import { useState, useCallback } from 'react'
import { useSearchParams } from 'next/navigation'
import { useQueryClient } from '@tanstack/react-query'
import { UserTable } from './UserTable'
import { UserTablePagination } from './UserTablePagination'
import { BulkActionBar, BulkConfirmDialog, TypeToConfirmDialog } from '@/components/bulk-operations'
import { useBulkSelection } from '@/hooks/useBulkSelection'
import { useBulkProgress } from '@/hooks/useBulkProgress'
import type { UserListItem } from '@/types/user'

interface UserListClientProps {
  initialData: UserListItem[]
  pagination: {
    page: number
    pageSize: number
    totalPages: number
    totalItems: number
  }
}

type BulkUserAction = 'suspend' | 'unsuspend' | 'delete' | null

export function UserListClient({ initialData, pagination }: UserListClientProps) {
  const searchParams = useSearchParams()
  const queryClient = useQueryClient()
  const [currentAction, setCurrentAction] = useState<BulkUserAction>(null)

  const bulkSelection = useBulkSelection({
    entityType: 'user',
    filterParams: searchParams,
    totalFilteredCount: pagination.totalItems,
  })

  const bulkProgress = useBulkProgress()

  const handleBulkAction = useCallback(async (action: string) => {
    const ids = Array.from(bulkSelection.selectedIds)
    const result = await bulkProgress.startOperation('/users/bulk', {
      action,
      ids,
    })

    if (result.success) {
      bulkSelection.clearSelection()
      queryClient.invalidateQueries({ queryKey: ['users'] })
    }

    setCurrentAction(null)
  }, [bulkSelection, bulkProgress, queryClient])

  const handleConfirm = useCallback(() => {
    if (currentAction) {
      handleBulkAction(currentAction)
    }
  }, [currentAction, handleBulkAction])

  return (
    <>
      <UserTable
        data={initialData}
        pagination={pagination}
      />

      <UserTablePagination pagination={pagination} />

      <BulkActionBar
        selectedCount={bulkSelection.selectedCount}
        entityType="user"
        onClearSelection={bulkSelection.clearSelection}
        isOperationRunning={bulkProgress.isRunning}
        onSuspend={() => setCurrentAction('suspend')}
        onUnsuspend={() => setCurrentAction('unsuspend')}
        onDeleteUsers={() => setCurrentAction('delete')}
      />

      {/* Simple confirmation for suspend/unsuspend */}
      {currentAction && currentAction !== 'delete' && (
        <BulkConfirmDialog
          open={true}
          onOpenChange={(open) => !open && setCurrentAction(null)}
          action={currentAction}
          itemCount={bulkSelection.selectedCount}
          entityType="user"
          onConfirm={handleConfirm}
          isLoading={bulkProgress.isRunning}
        />
      )}

      {/* Type-to-confirm for delete */}
      {currentAction === 'delete' && (
        <TypeToConfirmDialog
          open={true}
          onOpenChange={(open) => !open && setCurrentAction(null)}
          action="delete"
          itemCount={bulkSelection.selectedCount}
          entityType="user"
          onConfirm={handleConfirm}
          isLoading={bulkProgress.isRunning}
        />
      )}
    </>
  )
}
```

Update `src/app/(platform)/users/page.tsx` to use UserListClient:
```typescript
import { UserListClient } from './components/UserListClient'
// ... keep existing imports and server data fetching

export default async function UsersPage({ searchParams }: { searchParams: Promise<...> }) {
  // ... existing data fetching logic

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-semibold text-gray-900">Users</h1>
        {/* ... existing export button */}
      </div>

      <UserFilters />

      <UserListClient
        initialData={response.data}
        pagination={response.pagination}
      />
    </div>
  )
}
```

Add UserListClient to barrel export in `src/app/(platform)/users/components/index.ts`:
```typescript
export { UserListClient } from './UserListClient'
```
  </action>
  <verify>
1. npx tsc --noEmit passes
2. npm run build succeeds
  </verify>
  <done>
- UserListClient wraps table with bulk selection and action bar
- BulkActionBar shows user-specific actions (suspend, unsuspend, delete)
- Suspend/Unsuspend use simple confirmation
- Delete uses type-to-confirm
- Operations invalidate query cache on success
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. UserTable has checkbox column: `grep "select" src/app/(platform)/users/components/UserTable.tsx`
3. BulkActionBar integrated: `grep "BulkActionBar" src/app/(platform)/users/components/UserListClient.tsx`
4. Build succeeds: `npm run build`
</verification>

<success_criteria>
- UserTable shows checkbox column as first column
- Clicking checkbox toggles individual selection
- Shift+Click selects range of rows across pages (fetches all filtered IDs if needed)
- Header checkbox selects ALL items matching current filters across all pages (via /bulk/ids)
- BulkActionBar appears when items selected with user actions (suspend, unsuspend, delete)
- Suspend/Unsuspend show simple confirmation
- Delete shows type-to-confirm
- Build passes: `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/05-bulk-operations/05-06-SUMMARY.md`
</output>
