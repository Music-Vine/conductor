---
phase: 05-bulk-operations
plan: 07
type: execute
wave: 4
depends_on: ["05-05", "05-06"]
files_modified:
  - src/lib/bulk-operations/audit.ts
  - src/app/api/assets/bulk/route.ts
  - src/app/api/users/bulk/route.ts
autonomous: true

must_haves:
  truths:
    - "Single audit log entry created per bulk operation"
    - "Audit log includes operation ID, action type, affected count, and actor"
    - "Audit entry references all affected item IDs"
  artifacts:
    - path: "src/lib/bulk-operations/audit.ts"
      provides: "Bulk audit logging utilities"
      exports: ["createBulkAuditEntry", "BulkAuditEntry"]
  key_links:
    - from: "src/app/api/assets/bulk/route.ts"
      to: "src/lib/bulk-operations/audit.ts"
      via: "Audit logging on completion"
      pattern: "createBulkAuditEntry"
---

<objective>
Add bulk audit logging to track completed bulk operations.

Purpose: Per CONTEXT decision, create a single audit log entry per bulk operation (not per item) that records what changed and can be referenced by operation ID.

Output: Bulk audit utilities and integration with bulk API routes.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bulk-operations/05-CONTEXT.md

# Existing audit patterns
@src/hooks/useAuditLog.ts
@src/lib/audit/types.ts

# Bulk routes to update
@src/app/api/assets/bulk/route.ts
@src/app/api/users/bulk/route.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create bulk audit logging utilities</name>
  <files>src/lib/bulk-operations/audit.ts</files>
  <action>
Create `src/lib/bulk-operations/audit.ts` for bulk operation audit logging:

**Types:**
```typescript
export interface BulkAuditEntry {
  operationId: string
  action: string
  entityType: 'asset' | 'user'
  affectedIds: string[]
  affectedCount: number
  actorId: string | null // null until auth implemented
  timestamp: string
  status: 'completed' | 'failed'
  errorMessage?: string
  payload?: Record<string, unknown> // Action-specific data (e.g., tag name, collection ID)
}

export interface CreateBulkAuditParams {
  operationId: string
  action: string
  entityType: 'asset' | 'user'
  affectedIds: string[]
  actorId?: string | null
  status: 'completed' | 'failed'
  errorMessage?: string
  payload?: Record<string, unknown>
}
```

**Implementation:**
```typescript
// In-memory storage for mock (replace with database in production)
const auditLog: BulkAuditEntry[] = []

export function createBulkAuditEntry(params: CreateBulkAuditParams): BulkAuditEntry {
  const entry: BulkAuditEntry = {
    operationId: params.operationId,
    action: params.action,
    entityType: params.entityType,
    affectedIds: params.affectedIds,
    affectedCount: params.affectedIds.length,
    actorId: params.actorId ?? null,
    timestamp: new Date().toISOString(),
    status: params.status,
    errorMessage: params.errorMessage,
    payload: params.payload,
  }

  // Store in mock audit log
  auditLog.push(entry)

  // Log to console in development
  if (process.env.NODE_ENV === 'development') {
    console.log('[Bulk Audit]', JSON.stringify(entry, null, 2))
  }

  return entry
}

export function getBulkAuditEntries(): BulkAuditEntry[] {
  return [...auditLog]
}

export function getBulkAuditEntry(operationId: string): BulkAuditEntry | undefined {
  return auditLog.find(entry => entry.operationId === operationId)
}

// Format audit entry for display
export function formatBulkAuditMessage(entry: BulkAuditEntry): string {
  const actionVerb = getActionVerb(entry.action)
  return `Bulk ${actionVerb} ${entry.affectedCount} ${entry.entityType}${entry.affectedCount === 1 ? '' : 's'}`
}

function getActionVerb(action: string): string {
  const verbs: Record<string, string> = {
    approve: 'approved',
    reject: 'rejected',
    delete: 'deleted',
    archive: 'archived',
    takedown: 'took down',
    'add-tag': 'tagged',
    'remove-tag': 'untagged',
    'add-to-collection': 'added to collection',
    'remove-from-collection': 'removed from collection',
    'set-platform': 'updated platform for',
    suspend: 'suspended',
    unsuspend: 'unsuspended',
  }
  return verbs[action] || action
}
```
  </action>
  <verify>npx tsc --noEmit passes with no errors related to audit.ts</verify>
  <done>Bulk audit utilities created with createBulkAuditEntry, getBulkAuditEntries, formatBulkAuditMessage</done>
</task>

<task type="auto">
  <name>Task 2: Integrate audit logging with bulk API routes</name>
  <files>src/app/api/assets/bulk/route.ts, src/app/api/users/bulk/route.ts</files>
  <action>
Update `src/app/api/assets/bulk/route.ts` to create audit entry on completion or failure:

**Add import:**
```typescript
import { createBulkAuditEntry } from '@/lib/bulk-operations/audit'
```

**Update stream completion handling:**
After sending 'complete' event:
```typescript
// Create audit entry for successful operation
createBulkAuditEntry({
  operationId,
  action,
  entityType: 'asset',
  affectedIds: assetIds,
  status: 'completed',
  payload,
})
```

After sending 'error' event:
```typescript
// Create audit entry for failed operation
createBulkAuditEntry({
  operationId,
  action,
  entityType: 'asset',
  affectedIds: assetIds.slice(0, i), // Only IDs processed before failure
  status: 'failed',
  errorMessage: error.message,
  payload,
})
```

**Apply same changes to `src/app/api/users/bulk/route.ts`:**
- Import createBulkAuditEntry
- Create audit entry on completion with entityType: 'user'
- Create audit entry on failure with entityType: 'user'
  </action>
  <verify>
1. npx tsc --noEmit passes
2. grep "createBulkAuditEntry" src/app/api/assets/bulk/route.ts shows import and usage
3. grep "createBulkAuditEntry" src/app/api/users/bulk/route.ts shows import and usage
  </verify>
  <done>
- Audit entry created on successful bulk operation completion
- Audit entry created on bulk operation failure
- Both asset and user bulk routes integrated with audit logging
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Audit utilities exist: `ls src/lib/bulk-operations/audit.ts`
3. Asset bulk route has audit: `grep "createBulkAuditEntry" src/app/api/assets/bulk/route.ts`
4. User bulk route has audit: `grep "createBulkAuditEntry" src/app/api/users/bulk/route.ts`
5. Build succeeds: `npm run build`
</verification>

<success_criteria>
- createBulkAuditEntry function creates single entry per bulk operation
- Audit entry includes: operationId, action, entityType, affectedIds, affectedCount, timestamp, status
- Asset bulk route creates audit entry on completion/failure
- User bulk route creates audit entry on completion/failure
- Audit entries logged to console in development
- Build passes: `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/05-bulk-operations/05-07-SUMMARY.md`
</output>
