---
phase: 05-bulk-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks/useBulkSelection.ts
  - src/lib/bulk-operations/selection.ts
  - src/hooks/index.ts
autonomous: true

must_haves:
  truths:
    - "Selection state persists across page navigation within a session"
    - "Select All fetches and stores all IDs matching current filters"
    - "Shift+Click selects range between last focused item and clicked item"
    - "Selection clears when filters change or user navigates away from table page"
  artifacts:
    - path: "src/hooks/useBulkSelection.ts"
      provides: "Cross-page bulk selection hook with Jotai state"
      exports: ["useBulkSelection"]
    - path: "src/lib/bulk-operations/selection.ts"
      provides: "Selection state utilities and types"
      exports: ["BulkSelectionState", "SelectionContext"]
  key_links:
    - from: "src/hooks/useBulkSelection.ts"
      to: "jotai"
      via: "atomWithStorage for selection persistence"
      pattern: "atomWithStorage.*bulk-selection"
---

<objective>
Create the bulk selection state management infrastructure using Jotai atoms with localStorage persistence.

Purpose: Enable selection state that persists across page navigation and supports "Select All" across filtered datasets with thousands of items, as required by CONTEXT decisions.

Output: useBulkSelection hook and supporting utilities for cross-page selection management.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bulk-operations/05-CONTEXT.md
@.planning/phases/05-bulk-operations/05-RESEARCH.md

# Prior patterns
@src/hooks/useTableKeyboard.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create selection state utilities and types</name>
  <files>src/lib/bulk-operations/selection.ts</files>
  <action>
Create selection state utilities in `src/lib/bulk-operations/selection.ts`:

**Types:**
- `SelectionContext`: { entityType: 'asset' | 'user', filterParams: URLSearchParams } - tracks what entity and filters the selection applies to
- `BulkSelectionState`: { selectedIds: Set<string>, lastSelectedId: string | null, context: SelectionContext | null }

**Utilities:**
- `serializeSelection(state: BulkSelectionState): string` - Serialize for localStorage (convert Set to array)
- `deserializeSelection(json: string): BulkSelectionState` - Deserialize from localStorage (array back to Set)
- `createEmptySelection(): BulkSelectionState` - Factory for initial state
- `contextMatches(current: SelectionContext | null, entityType: string, filterParams: URLSearchParams): boolean` - Check if selection is still valid for current view (returns false if entity type or filter params changed)

The contextMatches function should compare entityType directly and compare filterParams by stringifying both (sort keys for consistent comparison).

Create directory `src/lib/bulk-operations/` if it doesn't exist.
  </action>
  <verify>npx tsc --noEmit passes with no errors related to selection.ts</verify>
  <done>Selection types and utilities exported from src/lib/bulk-operations/selection.ts</done>
</task>

<task type="auto">
  <name>Task 2: Create useBulkSelection hook with Jotai</name>
  <files>src/hooks/useBulkSelection.ts, src/hooks/index.ts</files>
  <action>
Create `src/hooks/useBulkSelection.ts` with Jotai atomWithStorage for cross-page selection:

**Jotai Atom:**
```typescript
const bulkSelectionAtom = atomWithStorage<BulkSelectionState>(
  'bulk-selection',
  createEmptySelection(),
  {
    getItem: (key, initialValue) => {
      const stored = localStorage.getItem(key)
      if (!stored) return initialValue
      return deserializeSelection(stored)
    },
    setItem: (key, value) => {
      localStorage.setItem(key, serializeSelection(value))
    },
    removeItem: (key) => localStorage.removeItem(key),
  },
  { getOnInit: true }
)
```

**Hook signature:**
```typescript
interface UseBulkSelectionOptions {
  entityType: 'asset' | 'user'
  filterParams: URLSearchParams
  totalFilteredCount?: number // For "Select all X items" display
}

interface UseBulkSelectionReturn {
  selectedIds: Set<string>
  selectedCount: number
  isAllSelected: boolean
  lastSelectedId: string | null

  // Selection actions
  select: (id: string) => void
  deselect: (id: string) => void
  toggle: (id: string) => void
  selectRange: (fromId: string, toId: string, orderedIds: string[]) => void
  selectAll: (allIds: string[]) => void
  clearSelection: () => void

  // State checks
  isSelected: (id: string) => boolean
}
```

**Implementation details:**

1. On mount, check if stored selection context matches current (entityType + filterParams). If not, clear selection per CONTEXT decision: "Selection clears when staff apply new filters or navigate away."

2. `selectRange(fromId, toId, orderedIds)`: Find indices of fromId and toId in orderedIds array, select all IDs between them (inclusive). This handles cross-page range selection when called with full ordered ID list.

3. `selectAll(allIds)`: Set selectedIds to all provided IDs. The caller is responsible for fetching all filtered IDs from API.

4. `toggle(id)`: If selected, deselect. Otherwise select and update lastSelectedId.

5. `select(id)`: Add to Set, update lastSelectedId.

6. Update context whenever selection changes (entityType + filterParams snapshot).

7. `isAllSelected`: Compare selectedIds.size === totalFilteredCount (if provided).

Add export to `src/hooks/index.ts`:
```typescript
export { useBulkSelection } from './useBulkSelection'
```
  </action>
  <verify>
1. npx tsc --noEmit passes
2. Check that useBulkSelection is exported from src/hooks/index.ts
  </verify>
  <done>
- useBulkSelection hook exported and working with Jotai persistence
- Selection clears on filter/entity type change
- selectRange handles cross-page range selection
- selectAll accepts pre-fetched ID array
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. Exports are correct: `grep -r "useBulkSelection" src/hooks/index.ts` shows export
3. Jotai atom uses atomWithStorage: `grep "atomWithStorage" src/hooks/useBulkSelection.ts`
4. Selection context validation exists: `grep "contextMatches" src/hooks/useBulkSelection.ts`
</verification>

<success_criteria>
- useBulkSelection hook created with Jotai atomWithStorage persistence
- Selection state includes: selectedIds (Set), lastSelectedId, context
- Selection clears when entityType or filterParams change
- selectRange and selectAll methods implemented for cross-page selection
- All TypeScript types are properly defined
- Build passes: `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/05-bulk-operations/05-01-SUMMARY.md`
</output>
