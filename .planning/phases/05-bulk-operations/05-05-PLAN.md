---
phase: 05-bulk-operations
plan: 05
type: execute
wave: 3
depends_on: ["05-03", "05-04"]
files_modified:
  - src/app/(platform)/assets/components/AssetTable.tsx
  - src/app/(platform)/assets/components/AssetTableHeader.tsx
  - src/app/(platform)/assets/page.tsx
autonomous: true

must_haves:
  truths:
    - "Asset table shows checkbox column for selection"
    - "Header checkbox selects all items matching current filters across all pages (via /bulk/ids endpoint)"
    - "Shift+Click selects range between last selected and clicked row, works across pages"
    - "Selection clears when filters change"
    - "Floating action bar appears with asset-specific actions when items selected"
  artifacts:
    - path: "src/app/(platform)/assets/components/AssetTable.tsx"
      provides: "AssetTable with bulk selection support"
      contains: "useBulkSelection"
    - path: "src/app/(platform)/assets/components/AssetTableHeader.tsx"
      provides: "Table header with select all checkbox"
      exports: ["AssetTableHeader"]
  key_links:
    - from: "src/app/(platform)/assets/components/AssetTable.tsx"
      to: "src/hooks/useBulkSelection.ts"
      via: "Selection state hook"
      pattern: "useBulkSelection"
    - from: "src/app/(platform)/assets/page.tsx"
      to: "src/components/bulk-operations/BulkActionBar.tsx"
      via: "Floating action bar"
      pattern: "BulkActionBar"
---

<objective>
Integrate bulk selection and operations into the AssetTable component.

Purpose: Enable staff to select multiple assets and perform bulk operations (approve, reject, delete, add tags, etc.) per CONTEXT decisions.

Output: AssetTable with checkbox selection, Shift+Click range selection, header select-all, and connected BulkActionBar.
</objective>

<execution_context>
@/Users/sambeevors/.claude/get-shit-done/workflows/execute-plan.md
@/Users/sambeevors/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-bulk-operations/05-CONTEXT.md
@.planning/phases/05-bulk-operations/05-RESEARCH.md

# Prior plan outputs
@src/hooks/useBulkSelection.ts
@src/hooks/useBulkProgress.ts
@src/components/bulk-operations/BulkActionBar.tsx
@src/components/bulk-operations/BulkConfirmDialog.tsx
@src/components/bulk-operations/TypeToConfirmDialog.tsx

# Current implementation
@src/app/(platform)/assets/components/AssetTable.tsx
@src/app/(platform)/assets/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add checkbox column and selection to AssetTable</name>
  <files>src/app/(platform)/assets/components/AssetTable.tsx</files>
  <action>
Update `src/app/(platform)/assets/components/AssetTable.tsx` to add bulk selection support:

**Changes:**

1. Import new hooks and types:
```typescript
import { useBulkSelection } from '@/hooks/useBulkSelection'
import { useSearchParams } from 'next/navigation'
```

2. Update AssetTableProps to include callback for selected IDs:
```typescript
interface AssetTableProps {
  data: AssetListItem[]
  pagination: {
    page: number
    pageSize: number
    totalPages: number
    totalItems: number
  }
  onSelectionChange?: (selectedIds: string[]) => void
}
```

3. Add state and fetch function for all filtered IDs (for Select All and cross-page Shift+Click):
```typescript
const [allFilteredIds, setAllFilteredIds] = useState<string[] | null>(null)
const [isLoadingAllIds, setIsLoadingAllIds] = useState(false)

// Fetch all filtered IDs from /bulk/ids endpoint
const fetchAllFilteredIds = useCallback(async (): Promise<string[]> => {
  if (allFilteredIds) return allFilteredIds // Cache hit

  setIsLoadingAllIds(true)
  try {
    const params = new URLSearchParams(searchParams.toString())
    const response = await fetch(`/api/assets/bulk/ids?${params}`)
    const { ids } = await response.json()
    setAllFilteredIds(ids)
    return ids
  } finally {
    setIsLoadingAllIds(false)
  }
}, [searchParams, allFilteredIds])

// Clear cached IDs when filters change
useEffect(() => {
  setAllFilteredIds(null)
}, [searchParams])
```

4. Add checkbox column as first column:
```typescript
const checkboxColumn = columnHelper.display({
  id: 'select',
  header: ({ table }) => null, // Header checkbox handled separately
  size: 48,
  cell: ({ row }) => {
    const isSelected = bulkSelection.isSelected(row.original.id)
    return (
      <div className="flex items-center justify-center">
        <input
          type="checkbox"
          checked={isSelected}
          onChange={() => bulkSelection.toggle(row.original.id)}
          onClick={async (e) => {
            // Handle Shift+Click for range selection (works across pages)
            if (e.shiftKey && bulkSelection.lastSelectedId) {
              e.preventDefault()
              // Fetch all filtered IDs for cross-page range selection
              const orderedIds = await fetchAllFilteredIds()
              bulkSelection.selectRange(bulkSelection.lastSelectedId, row.original.id, orderedIds)
            }
          }}
          className="h-4 w-4 rounded border-gray-300 text-platform-primary focus:ring-platform-primary"
        />
      </div>
    )
  },
})
```

5. Add the checkbox column at the start of columns array:
```typescript
const columns = [
  checkboxColumn,
  // ... existing columns
]
```

6. Initialize useBulkSelection in component:
```typescript
const searchParams = useSearchParams()

const bulkSelection = useBulkSelection({
  entityType: 'asset',
  filterParams: searchParams,
  totalFilteredCount: pagination.totalItems,
})

// Notify parent of selection changes
useEffect(() => {
  onSelectionChange?.(Array.from(bulkSelection.selectedIds))
}, [bulkSelection.selectedIds, onSelectionChange])
```

7. Update row rendering to show selected state:
- Row with isSelected should have `bg-platform-primary/10` background
- Update the VirtualizedRow className logic

8. Update gridTemplateColumns to include checkbox column width (48px):
```typescript
const gridTemplateColumns = '48px 350px 120px 1fr 140px 120px 140px 100px'
```

9. Add header row for selection checkbox (outside virtualized area):
```typescript
// For the indeterminate checkbox state, use a ref:
const headerCheckboxRef = useRef<HTMLInputElement>(null)
useEffect(() => {
  if (headerCheckboxRef.current) {
    headerCheckboxRef.current.indeterminate = bulkSelection.selectedCount > 0 && !bulkSelection.isAllSelected
  }
}, [bulkSelection.selectedCount, bulkSelection.isAllSelected])

// In the header section, add a checkbox cell:
<div className="flex items-center justify-center px-3">
  <input
    ref={headerCheckboxRef}
    type="checkbox"
    checked={bulkSelection.isAllSelected && bulkSelection.selectedCount > 0}
    disabled={isLoadingAllIds}
    onChange={async () => {
      if (bulkSelection.selectedCount > 0) {
        bulkSelection.clearSelection()
      } else {
        // Select ALL filtered IDs across all pages (per CONTEXT decision)
        const allIds = await fetchAllFilteredIds()
        bulkSelection.selectAll(allIds)
      }
    }}
    className="h-4 w-4 rounded border-gray-300 text-platform-primary focus:ring-platform-primary disabled:opacity-50"
  />
</div>
```

**IMPORTANT:** The header checkbox MUST fetch ALL filtered IDs from `/api/assets/bulk/ids` endpoint, NOT just current page IDs. This honors the CONTEXT decision: "Select All selects all items matching current filters across all pages."
  </action>
  <verify>
1. npx tsc --noEmit passes
2. Checkbox column appears in table
  </verify>
  <done>
- AssetTable has checkbox column for row selection
- Shift+Click enables range selection across pages (fetches all filtered IDs)
- Header checkbox selects ALL filtered items across all pages (via /bulk/ids endpoint)
- Selected rows highlighted with platform-primary color
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate BulkActionBar with asset page</name>
  <files>src/app/(platform)/assets/page.tsx</files>
  <action>
Update `src/app/(platform)/assets/page.tsx` to include BulkActionBar and bulk operations:

**Changes:**

1. Convert to client component or create a client wrapper component. Since page.tsx is a server component for data fetching, create a new client component `AssetListClient.tsx` that wraps the table and action bar.

Create `src/app/(platform)/assets/components/AssetListClient.tsx`:
```typescript
'use client'

import { useState, useCallback } from 'react'
import { useSearchParams } from 'next/navigation'
import { useQueryClient } from '@tanstack/react-query'
import { AssetTable } from './AssetTable'
import { AssetTablePagination } from './AssetTablePagination'
import { BulkActionBar, BulkConfirmDialog, TypeToConfirmDialog } from '@/components/bulk-operations'
import { useBulkSelection } from '@/hooks/useBulkSelection'
import { useBulkProgress } from '@/hooks/useBulkProgress'
import type { AssetListItem } from '@/types/asset'

interface AssetListClientProps {
  initialData: AssetListItem[]
  pagination: {
    page: number
    pageSize: number
    totalPages: number
    totalItems: number
  }
}

type BulkAction = 'approve' | 'reject' | 'delete' | 'archive' | 'takedown' | 'add-tag' | null
type DestructiveAction = 'delete' | 'archive' | 'takedown'

export function AssetListClient({ initialData, pagination }: AssetListClientProps) {
  const searchParams = useSearchParams()
  const queryClient = useQueryClient()
  const [currentAction, setCurrentAction] = useState<BulkAction>(null)

  const bulkSelection = useBulkSelection({
    entityType: 'asset',
    filterParams: searchParams,
    totalFilteredCount: pagination.totalItems,
  })

  const bulkProgress = useBulkProgress()

  const isDestructive = (action: BulkAction): action is DestructiveAction => {
    return action === 'delete' || action === 'archive' || action === 'takedown'
  }

  const handleBulkAction = useCallback(async (action: string) => {
    const ids = Array.from(bulkSelection.selectedIds)
    const result = await bulkProgress.startOperation('/assets/bulk', {
      action,
      ids,
    })

    if (result.success) {
      bulkSelection.clearSelection()
      // Invalidate queries to refresh data
      queryClient.invalidateQueries({ queryKey: ['assets'] })
    }

    setCurrentAction(null)
  }, [bulkSelection, bulkProgress, queryClient])

  const handleConfirm = useCallback(() => {
    if (currentAction) {
      handleBulkAction(currentAction)
    }
  }, [currentAction, handleBulkAction])

  return (
    <>
      <AssetTable
        data={initialData}
        pagination={pagination}
      />

      <AssetTablePagination pagination={pagination} />

      <BulkActionBar
        selectedCount={bulkSelection.selectedCount}
        entityType="asset"
        onClearSelection={bulkSelection.clearSelection}
        isOperationRunning={bulkProgress.isRunning}
        onApprove={() => setCurrentAction('approve')}
        onReject={() => setCurrentAction('reject')}
        onDelete={() => setCurrentAction('delete')}
        onArchive={() => setCurrentAction('archive')}
        onTakedown={() => setCurrentAction('takedown')}
        onAddTag={() => setCurrentAction('add-tag')}
      />

      {/* Simple confirmation for non-destructive actions */}
      {currentAction && !isDestructive(currentAction) && (
        <BulkConfirmDialog
          open={true}
          onOpenChange={(open) => !open && setCurrentAction(null)}
          action={currentAction}
          itemCount={bulkSelection.selectedCount}
          entityType="asset"
          onConfirm={handleConfirm}
          isLoading={bulkProgress.isRunning}
        />
      )}

      {/* Type-to-confirm for destructive actions */}
      {currentAction && isDestructive(currentAction) && (
        <TypeToConfirmDialog
          open={true}
          onOpenChange={(open) => !open && setCurrentAction(null)}
          action={currentAction}
          itemCount={bulkSelection.selectedCount}
          entityType="asset"
          onConfirm={handleConfirm}
          isLoading={bulkProgress.isRunning}
        />
      )}
    </>
  )
}
```

2. Update `src/app/(platform)/assets/page.tsx` to use the client wrapper:
```typescript
import { AssetListClient } from './components/AssetListClient'
// ... existing imports and data fetching

export default async function AssetsPage({ searchParams }: { searchParams: Promise<...> }) {
  // ... existing data fetching logic

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h1 className="text-2xl font-semibold text-gray-900">Assets</h1>
        {/* ... existing buttons */}
      </div>

      <AssetFilters />

      <AssetListClient
        initialData={response.data}
        pagination={response.pagination}
      />
    </div>
  )
}
```

3. Add AssetListClient to barrel export in `src/app/(platform)/assets/components/index.ts`
  </action>
  <verify>
1. npx tsc --noEmit passes
2. npm run build succeeds
  </verify>
  <done>
- AssetListClient wraps table with bulk selection and action bar
- BulkActionBar shows when items selected
- Confirmation dialogs wired up (simple for safe, type-to-confirm for destructive)
- Operations invalidate query cache on success
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation: `npx tsc --noEmit` passes
2. AssetTable has checkbox column: `grep "select" src/app/(platform)/assets/components/AssetTable.tsx`
3. BulkActionBar integrated: `grep "BulkActionBar" src/app/(platform)/assets/components/AssetListClient.tsx`
4. Dialogs integrated: `grep "TypeToConfirmDialog" src/app/(platform)/assets/components/AssetListClient.tsx`
5. Build succeeds: `npm run build`
</verification>

<success_criteria>
- AssetTable shows checkbox column as first column
- Clicking checkbox toggles individual selection
- Shift+Click selects range of rows across pages (fetches all filtered IDs if needed)
- Header checkbox selects ALL items matching current filters across all pages (via /bulk/ids)
- BulkActionBar appears when items selected with asset-specific actions
- Approve/Reject show simple confirmation
- Delete/Archive/Takedown show type-to-confirm
- Operations trigger toast progress and invalidate cache on complete
- Build passes: `npm run build`
</success_criteria>

<output>
After completion, create `.planning/phases/05-bulk-operations/05-05-SUMMARY.md`
</output>
